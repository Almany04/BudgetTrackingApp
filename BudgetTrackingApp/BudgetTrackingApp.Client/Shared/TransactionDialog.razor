@inject HttpClient Http
@inject DialogService DialogService
@inject NotificationService NotificationService
@using BudgetTrackingApp.Shared.Dtos.Transactions
@using BudgetTrackingApp.Shared.Dtos.Category
@using BudgetTrackingApp.Shared.Enums

<RadzenTemplateForm TItem="TransactionUpdateDto" Data="@TransactionModel" Submit="@(args => OnSubmit(args))">
    <RadzenStack Spacing="1.5rem">

        <RadzenRow>
            <RadzenColumn Size="12" SizeMD="6">
                <RadzenFormField Text="Type" Variant="Variant.Outlined" Style="width: 100%">
                    <RadzenDropDown @bind-Value="TransactionModel.Type"
                                    Data="@(Enum.GetValues(typeof(TransactionType)))"
                                    Name="Type" />
                </RadzenFormField>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="6">
                <RadzenFormField Text="Amount (HUF)" Variant="Variant.Outlined" Style="width: 100%">
                    <RadzenNumeric @bind-Value="TransactionModel.Amount" Name="Amount" Min="1" />
                </RadzenFormField>
                <RadzenRequiredValidator Component="Amount" Text="Amount is required!" />
                <RadzenNumericRangeValidator Component="Amount" Min="1" Text="Amount must be greater than 0!" />
            </RadzenColumn>
        </RadzenRow>

        <RadzenFormField Text="Category" Variant="Variant.Outlined">
            <RadzenDropDown @bind-Value="TransactionModel.CategoryId"
                            Data="@categories"
                            TextProperty="Name"
                            ValueProperty="Id"
                            Name="CategoryId"
                            Placeholder="Select a category..."
                            AllowClear="true"
                            Style="width: 100%" />
        </RadzenFormField>
        <RadzenRequiredValidator Component="CategoryId" Text="Category selection is required!" DefaultValue="Guid.Empty" />

        <RadzenFormField Text="Date" Variant="Variant.Outlined">
            <RadzenDatePicker @bind-Value="TransactionModel.TransactionDate" Name="TransactionDate" DateFormat="yyyy.MM.dd" Style="width: 100%" />
        </RadzenFormField>
        <RadzenRequiredValidator Component="TransactionDate" Text="Date is required!" />

        <RadzenFormField Text="Description / Note" Variant="Variant.Outlined">
            <RadzenTextArea @bind-Value="TransactionModel.Description" Rows="3" Name="Description" Style="width: 100%" />
        </RadzenFormField>

        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="1rem" Class="rz-mt-2">
            <RadzenButton ButtonType="ButtonType.Submit" Text="Save" Icon="save" ButtonStyle="ButtonStyle.Primary" Disabled="@isProcessing" IsBusy="@isProcessing" />
            <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@(() => DialogService.Close(false))" Disabled="@isProcessing" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>

@code {
    
    [Parameter] public Guid? TransactionId { get; set; }
    public TransactionUpdateDto TransactionModel { get; set; } = new() { TransactionDate = DateTime.Today };
    private IEnumerable<CategoryViewDto>? categories;
    private bool isProcessing = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategoriesAsync();
        if (TransactionId != null)
        {
            try
            {
                var t = await Http.GetFromJsonAsync<TransactionViewDto>($"api/transaction/{TransactionId}");
                if (t != null)
                {
                    TransactionModel = new TransactionUpdateDto
                    {
                        Amount = t.Amount,
                        CategoryId = t.CategoryId,
                        Description = t.Description,
                        TransactionDate = t.TransactionDate,
                        Type = t.Type
                    };
                }
            }
            catch
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load transaction data.");
                DialogService.Close(false);
            }
        }
        else if (categories?.Any() == true)
        {
            TransactionModel.CategoryId = categories.First().Id;
        }
    }

    private async Task LoadCategoriesAsync()
    {
        try { categories = await Http.GetFromJsonAsync<List<CategoryViewDto>>("api/categories"); } catch { }
    }

    private async Task OnSubmit(TransactionUpdateDto args)
    {
        isProcessing = true;
        try
        {
            HttpResponseMessage response;
            if (TransactionId == null)
            {
                var createDto = new TransactionCreateDto
                {
                    Amount = TransactionModel.Amount,
                    Type = TransactionModel.Type,
                    Description = TransactionModel.Description,
                    TransactionDate = TransactionModel.TransactionDate,
                    CategoryId = TransactionModel.CategoryId
                };
                response = await Http.PostAsJsonAsync("api/transaction", createDto);
            }
            else
            {
                response = await Http.PutAsJsonAsync($"api/transaction/{TransactionId}", TransactionModel);
            }

            if (response.IsSuccessStatusCode)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Transaction saved successfully!");
                DialogService.Close(true);
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                NotificationService.Notify(NotificationSeverity.Error, "Error", errorMsg);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
        finally
        {
            isProcessing = false;
        }
    }
}