@using BudgetTrackingApp.Shared.Dtos.Transactions
@using BudgetTrackingApp.Shared.Dtos.Category
@using BudgetTrackingApp.Shared.Enums
@inject HttpClient Http
@inject DialogService DialogService
@inject NotificationService NotificationService

<RadzenTemplateForm Data="@TransactionModel" Submit="@(async (TransactionUpdateDto args) => { await HandleSave(); })">
    <RadzenStack Spacing="3">
        <RadzenFormField Text="Összeg" Variant="Variant.Outlined">
            <RadzenNumeric @bind-Value="TransactionModel.Amount" Name="Amount" />
        </RadzenFormField>
        <RadzenRequiredValidator Component="Amount" Text="Összeg kötelező" />

        <RadzenFormField Text="Típus" Variant="Variant.Outlined">
            <RadzenDropDown @bind-Value="TransactionModel.Type" Data="@(Enum.GetValues(typeof(TransactionType)))" Name="Type" />
        </RadzenFormField>

        <RadzenFormField Text="Kategória" Variant="Variant.Outlined">
            <RadzenDropDown @bind-Value="TransactionModel.CategoryId" Data="@categories" TextProperty="Name" ValueProperty="Id" Name="CategoryId" Placeholder="Válassz..." />
        </RadzenFormField>
        <RadzenRequiredValidator Component="CategoryId" Text="Kategória kötelező" DefaultValue="Guid.Empty" />

        <RadzenFormField Text="Dátum" Variant="Variant.Outlined">
            <RadzenDatePicker @bind-Value="TransactionModel.TransactionDate" Name="TransactionDate" DateFormat="yyyy.MM.dd" />
        </RadzenFormField>

        <RadzenFormField Text="Leírás" Variant="Variant.Outlined">
            <RadzenTextArea @bind-Value="TransactionModel.Description" Rows="2" />
        </RadzenFormField>

        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="1rem" Class="rz-mt-4">
            <RadzenButton ButtonType="ButtonType.Submit" Text="Mentés" ButtonStyle="ButtonStyle.Primary" Disabled="@isProcessing" />
            <RadzenButton Text="Mégse" ButtonStyle="ButtonStyle.Light" Click="@(() => DialogService.Close(false))" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>

@code {
    [Parameter] public Guid? TransactionId { get; set; }

    public TransactionUpdateDto TransactionModel { get; set; } = new() { TransactionDate = DateTime.Today };
    private IEnumerable<CategoryViewDto>? categories;
    private bool isProcessing = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategoriesAsync();
        if (TransactionId != null)
        {
            // Betöltés szerkesztéshez (egyszerűsítve: lekérjük a listából vagy API-ról, itt most API hívás kellene, de a DTO-t újraépíthetjük)
            var t = await Http.GetFromJsonAsync<TransactionViewDto>($"api/transaction/{TransactionId}");
            if (t != null)
            {
                TransactionModel = new TransactionUpdateDto
                {
                    Amount = t.Amount,
                    CategoryId = t.CategoryId,
                    Description = t.Description,
                    TransactionDate = t.TransactionDate,
                    Type = t.Type
                };
            }
        }
        else if (categories?.Any() == true)
        {
            TransactionModel.CategoryId = categories.First().Id;
        }
    }

    private async Task LoadCategoriesAsync()
    {
        categories = await Http.GetFromJsonAsync<List<CategoryViewDto>>("api/categories");
    }

    private async Task HandleSave()
    {
        isProcessing = true;
        try
        {
            HttpResponseMessage response;
            if (TransactionId == null)
            {
                var createDto = new TransactionCreateDto
                {
                    Amount = TransactionModel.Amount,
                    Type = TransactionModel.Type,
                    Description = TransactionModel.Description,
                    TransactionDate = TransactionModel.TransactionDate,
                    CategoryId = TransactionModel.CategoryId
                };
                response = await Http.PostAsJsonAsync("api/transaction", createDto);
            }
            else
            {
                response = await Http.PutAsJsonAsync($"api/transaction/{TransactionId}", TransactionModel);
            }

            if (response.IsSuccessStatusCode)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Siker", "Mentés sikeres!");
                DialogService.Close(true);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Hiba", ex.Message);
        }
        finally
        {
            isProcessing = false;
        }
    }
}