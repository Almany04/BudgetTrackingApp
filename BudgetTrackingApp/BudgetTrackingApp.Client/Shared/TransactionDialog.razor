@inject HttpClient Http
@inject DialogService DialogService
@inject NotificationService NotificationService
@using BudgetTrackingApp.Shared.Dtos.Transactions
@using BudgetTrackingApp.Shared.Dtos.Category
@using BudgetTrackingApp.Shared.Enums

<RadzenTabs RenderMode="TabRenderMode.Client">
    <Tabs>
        <RadzenTabsItem Text="Single Item" Icon="receipt">
            <RadzenTemplateForm TItem="TransactionUpdateDto" Data="@TransactionModel" Submit="@OnSubmitSingle">
                <RadzenStack Spacing="1rem">

                    @* TYPE & PAYMENT *@
                    <RadzenRow>
                        @if (!ForcedType.HasValue)
                        {
                            <RadzenColumn Size="6">
                                <RadzenFormField Text="Type" Variant="Variant.Outlined" Style="width:100%">
                                    <RadzenDropDown @bind-Value="TransactionModel.Type" Data="@transactionTypes" TextProperty="Name" ValueProperty="Value" Name="Type" />
                                </RadzenFormField>
                            </RadzenColumn>
                        }
                        <RadzenColumn Size="@(ForcedType.HasValue ? 12 : 6)">
                            <RadzenFormField Text="Payment" Variant="Variant.Outlined" Style="width:100%">
                                <RadzenDropDown @bind-Value="TransactionModel.PaymentMethod" Data="@allPaymentMethods" TextProperty="Name" ValueProperty="Value" Name="PaymentMethod" />
                            </RadzenFormField>
                        </RadzenColumn>
                    </RadzenRow>

                    @* --- SPLIT LOGIC --- *@
                    <RadzenCard Style="background: rgba(255,255,255,0.05); padding: 1rem;">
                        <RadzenStack Gap="1rem">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenLabel Text="Split Expense?" Component="Split" Style="color: var(--text-secondary); font-weight: 600;" />
                                <RadzenSwitch @bind-Value="TransactionModel.IsSplit" Name="Split" />
                            </RadzenStack>

                            @if (TransactionModel.IsSplit)
                            {
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                    <span style="color: #a78bfa; width: 70px; font-size: 0.8rem;">Girlfriend</span>
                                    <RadzenSlider TValue="decimal" @bind-Value="mySharePercentDisplay" Min="0" Max="100" Step="5" Style="flex-grow: 1;" Change="@UpdateRatio" />
                                    <span style="color: #22c55e; width: 70px; text-align: right; font-size: 0.8rem;">Me (@mySharePercentDisplay.ToString("0")%)</span>
                                </RadzenStack>

                                <RadzenText TextStyle="TextStyle.Caption" Style="text-align: center; color: var(--text-secondary);">
                                    Who paid initially?
                                </RadzenText>
                                <RadzenSelectBar @bind-Value="TransactionModel.PaidBy" TValue="PaidBy" Size="ButtonSize.Small" Style="width: 100%;">
                                    <Items>
                                        <RadzenSelectBarItem Text="Me" Value="PaidBy.Me" />
                                        <RadzenSelectBarItem Text="Girlfriend" Value="PaidBy.Partner" />
                                    </Items>
                                </RadzenSelectBar>
                            }
                            else
                            {
                                <RadzenFormField Text="Paid By" Variant="Variant.Outlined">
                                    <RadzenDropDown @bind-Value="TransactionModel.PaidBy" Data="@paidByOptions" TextProperty="Name" ValueProperty="Value" />
                                </RadzenFormField>
                            }
                        </RadzenStack>
                    </RadzenCard>

                    @* REST OF FORM *@
                    @if (TransactionModel.Type == TransactionType.Expense)
                    {
                        <RadzenFormField Text="Merchant" Variant="Variant.Outlined">
                            <RadzenTextBox @bind-Value="TransactionModel.Merchant" Name="Merchant" Placeholder="e.g. Spar" Style="width: 100%" />
                        </RadzenFormField>
                    }

                    @if (TransactionModel.Type == TransactionType.Saving)
                    {
                        <RadzenFormField Text="Link to Goal" Variant="Variant.Outlined">
                            <RadzenDropDown Data="@savingGoals" TextProperty="Name" ValueProperty="Id" @bind-Value="TransactionModel.SavingGoalId" Placeholder="None (General Savings)" Style="width: 100%" />
                        </RadzenFormField>
                    }

                    @if (TransactionModel.Type != TransactionType.Saving)
                    {
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.End" Gap="0.5rem">
                            <RadzenFormField Text="Main Category" Variant="Variant.Outlined" Style="flex-grow: 1;">
                                <RadzenDropDown Data="@mainCategories" TextProperty="Name" ValueProperty="Id"
                                                @bind-Value="selectedMainCategoryId" Change="@OnMainCategoryChange"
                                                Placeholder="Select Group..." Style="width: 100%" />
                            </RadzenFormField>
                            <RadzenButton Icon="add_circle_outline" ButtonStyle="ButtonStyle.Primary"
                                          ToolTip="New Main Group"
                                          Click="@OpenCreateMainCategoryDialog" />
                        </RadzenStack>

                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.End" Gap="0.5rem">
                            <RadzenFormField Text="Sub Item" Variant="Variant.Outlined" Style="flex-grow: 1;">
                                <RadzenDropDown Data="@filteredSubCategories" TextProperty="Name" ValueProperty="Id"
                                                @bind-Value="TransactionModel.CategoryId" Name="CategoryId"
                                                Placeholder="Select..." Disabled="@(selectedMainCategoryId == null)" Style="width: 100%" />
                            </RadzenFormField>
                            <RadzenButton Icon="add" ButtonStyle="ButtonStyle.Secondary" ToolTip="New Sub-Item"
                                          Disabled="@(selectedMainCategoryId == null)" Click="@OpenCreateSubCategoryDialog" />
                        </RadzenStack>
                        <RadzenRequiredValidator Component="CategoryId" Text="Required" />
                    }

                    <RadzenFormField Text="Amount (HUF)" Variant="Variant.Outlined">
                        <RadzenNumeric @bind-Value="TransactionModel.Amount" Name="Amount" Min="1" />
                    </RadzenFormField>
                    <RadzenRequiredValidator Component="Amount" Text="Required" />

                    <RadzenFormField Text="Date" Variant="Variant.Outlined">
                        <RadzenDatePicker @bind-Value="TransactionModel.TransactionDate" Name="TransactionDate" />
                    </RadzenFormField>

                    <RadzenFormField Text="Description" Variant="Variant.Outlined">
                        <RadzenTextArea @bind-Value="TransactionModel.Description" Rows="2" />
                    </RadzenFormField>

                    <RadzenButton ButtonType="ButtonType.Submit" Text="Save Transaction" Icon="save" ButtonStyle="ButtonStyle.Primary" Style="width: 100%" IsBusy="@isProcessing" />
                </RadzenStack>
            </RadzenTemplateForm>
        </RadzenTabsItem>
    </Tabs>
</RadzenTabs>

@code {
    [Parameter] public Guid? TransactionId { get; set; }
    [Parameter] public TransactionType? ForcedType { get; set; }

    public TransactionUpdateDto TransactionModel { get; set; } = new() { TransactionDate = DateTime.Today };

    // Slider Value for UI (0-100)
    private decimal mySharePercentDisplay = 50;

    // Lists
    public class EnumItem<T> { public string Name { get; set; } public T Value { get; set; } }
    private List<EnumItem<TransactionType>> transactionTypes = Enum.GetValues(typeof(TransactionType)).Cast<TransactionType>().Select(e => new EnumItem<TransactionType> { Name = e.ToString(), Value = e }).ToList();
    private List<EnumItem<PaymentMethod>> allPaymentMethods = Enum.GetValues(typeof(PaymentMethod)).Cast<PaymentMethod>().Select(e => new EnumItem<PaymentMethod> { Name = e.ToString(), Value = e }).ToList();

    private List<EnumItem<PaidBy>> paidByOptions = new List<EnumItem<PaidBy>>
    {
        new EnumItem<PaidBy> { Name = "Me", Value = PaidBy.Me },
        new EnumItem<PaidBy> { Name = "Girlfriend", Value = PaidBy.Partner }
    };

    private List<CategoryViewDto> allCategories = new();
    private List<CategoryViewDto> mainCategories = new();
    private List<CategoryViewDto> filteredSubCategories = new();
    private List<SavingGoalDto> savingGoals = new();

    private Guid? selectedMainCategoryId;
    private bool isProcessing = false;

    protected override async Task OnInitializedAsync()
    {
        if (ForcedType.HasValue) TransactionModel.Type = ForcedType.Value;

        await LoadCategoriesAsync();
        await LoadGoalsAsync();

        if (TransactionId != null)
        {
            var t = await Http.GetFromJsonAsync<TransactionViewDto>($"api/transaction/{TransactionId}");
            if (t != null)
            {
                TransactionModel = new TransactionUpdateDto
                {
                    Amount = t.Amount,
                    Description = t.Description,
                    Merchant = t.Merchant,
                    PaymentMethod = t.PaymentMethod,
                    TransactionDate = t.TransactionDate,
                    Type = t.Type,
                    CategoryId = t.CategoryId,
                    PaidBy = t.PaidBy,
                    IsSplit = t.IsSplit,
                    MyShareRatio = t.MyShareRatio,
                    SavingGoalId = t.SavingGoalId
                };
                // Convert Ratio (0-1) to Percent (0-100) for UI
                mySharePercentDisplay = TransactionModel.MyShareRatio * 100;

                var currentCat = allCategories.FirstOrDefault(c => c.Id == t.CategoryId);
                if (currentCat?.ParentCategoryId != null)
                {
                    selectedMainCategoryId = currentCat.ParentCategoryId;
                    OnMainCategoryChange();
                }
            }
        }
    }

    private void UpdateRatio()
    {
        // Convert Percent (0-100) back to Ratio (0-1)
        TransactionModel.MyShareRatio = mySharePercentDisplay / 100m;
    }

    private async Task LoadCategoriesAsync()
    {
        var cats = await Http.GetFromJsonAsync<List<CategoryViewDto>>("api/categories");
        if (cats != null)
        {
            allCategories = cats;
            mainCategories = allCategories.Where(c => c.ParentCategoryId == null).OrderBy(c => c.Name).ToList();
        }
    }

    private async Task LoadGoalsAsync()
    {
        try { savingGoals = await Http.GetFromJsonAsync<List<SavingGoalDto>>("api/features/goals") ?? new(); } catch { }
    }

    private void OnMainCategoryChange()
    {
        if (selectedMainCategoryId != null)
            filteredSubCategories = allCategories.Where(c => c.ParentCategoryId == selectedMainCategoryId).OrderBy(c => c.Name).ToList();
        else
            filteredSubCategories.Clear();
    }

    private async Task OpenCreateMainCategoryDialog()
    {
        var model = new CategoryCreateDto { ParentCategoryId = null };
        var result = await DialogService.OpenAsync<CategoryDialog>("New Main Group",
            new Dictionary<string, object> { { "CategoryModel", model } },
            new DialogOptions() { Width = "400px", CssClass = "xtract-card" });
        if (result == true) await LoadCategoriesAsync();
    }

    private async Task OpenCreateSubCategoryDialog()
    {
        if (selectedMainCategoryId == null) return;
        var model = new CategoryCreateDto { ParentCategoryId = selectedMainCategoryId };
        var result = await DialogService.OpenAsync<CategoryDialog>("New Sub Item", new Dictionary<string, object> { { "CategoryModel", model } }, new DialogOptions() { Width = "400px", CssClass = "xtract-card" });
        if (result == true) await LoadCategoriesAsync();
    }

    private async Task OnSubmitSingle(TransactionUpdateDto args)
    {
        isProcessing = true;
        try
        {
            // Ensure ratio is set correctly before sending
            UpdateRatio();

            HttpResponseMessage response;
            if (TransactionId == null)
            {
                var createDto = new TransactionCreateDto
                {
                    Amount = TransactionModel.Amount,
                    Type = TransactionModel.Type,
                    Description = TransactionModel.Description,
                    Merchant = TransactionModel.Merchant,
                    PaymentMethod = TransactionModel.PaymentMethod,
                    TransactionDate = TransactionModel.TransactionDate,
                    CategoryId = TransactionModel.CategoryId,
                    PaidBy = TransactionModel.PaidBy,
                    IsSplit = TransactionModel.IsSplit,
                    MyShareRatio = TransactionModel.MyShareRatio,
                    SavingGoalId = TransactionModel.SavingGoalId
                };
                response = await Http.PostAsJsonAsync("api/transaction", createDto);
            }
            else
            {
                response = await Http.PutAsJsonAsync($"api/transaction/{TransactionId}", TransactionModel);
            }

            if (response.IsSuccessStatusCode) { DialogService.Close(true); NotificationService.Notify(NotificationSeverity.Success, "Saved!"); }
            else { NotificationService.Notify(NotificationSeverity.Error, "Error", await response.Content.ReadAsStringAsync()); }
        }
        finally { isProcessing = false; }
    }

    // Placeholder for bulk
    public BulkTransactionCreateDto BulkModel { get; set; } = new();
    private void AddBulkItem() { }
    private void RemoveBulkItem(TransactionItemDto i) { }
    private async Task OnSubmitBulk() { }
}