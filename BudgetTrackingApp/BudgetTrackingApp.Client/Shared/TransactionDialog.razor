@inject HttpClient Http
@inject DialogService DialogService
@inject NotificationService NotificationService
@using BudgetTrackingApp.Shared.Dtos.Transactions
@using BudgetTrackingApp.Shared.Dtos.Category
@using BudgetTrackingApp.Shared.Enums

<RadzenTemplateForm TItem="TransactionUpdateDto" Data="@TransactionModel" Submit="@OnSubmit">
    <RadzenStack Spacing="1rem">

        <RadzenRow>
            <RadzenColumn Size="6"><RadzenFormField Text="Type" Variant="Variant.Outlined" Style="width:100%"><RadzenDropDown @bind-Value="TransactionModel.Type" Data="@(Enum.GetValues(typeof(TransactionType)))" Name="Type" /></RadzenFormField></RadzenColumn>
            <RadzenColumn Size="6"><RadzenFormField Text="Payment" Variant="Variant.Outlined" Style="width:100%"><RadzenDropDown @bind-Value="TransactionModel.PaymentMethod" Data="@(Enum.GetValues(typeof(PaymentMethod)))" Name="PaymentMethod" /></RadzenFormField></RadzenColumn>
        </RadzenRow>

        @* 1. Merchant Input *@
        <RadzenFormField Text="Merchant (e.g. Spar)" Variant="Variant.Outlined">
            <RadzenTextBox @bind-Value="TransactionModel.Merchant" Name="Merchant" Style="width: 100%" />
        </RadzenFormField>
        <RadzenRequiredValidator Component="Merchant" Text="Required" />

        @* 2. Main Category Selection *@
        <RadzenFormField Text="Main Group (e.g. Groceries)" Variant="Variant.Outlined">
            <RadzenDropDown Data="@mainCategories" TextProperty="Name" ValueProperty="Id"
                            @bind-Value="selectedMainCategoryId" Change="@OnMainCategoryChange"
                            Placeholder="Select Main Group..." Style="width: 100%" />
        </RadzenFormField>

        @* 3. Sub Category Selection *@
        <RadzenFormField Text="Sub Item (e.g. Cheese)" Variant="Variant.Outlined">
            <RadzenDropDown Data="@filteredSubCategories" TextProperty="Name" ValueProperty="Id"
                            @bind-Value="TransactionModel.CategoryId" Name="CategoryId"
                            Placeholder="Select Specific Item..." Disabled="@(selectedMainCategoryId == null)" Style="width: 100%" />
        </RadzenFormField>
        <RadzenRequiredValidator Component="CategoryId" Text="Please select a sub-item" />

        <RadzenFormField Text="Amount (HUF)" Variant="Variant.Outlined">
            <RadzenNumeric @bind-Value="TransactionModel.Amount" Name="Amount" />
        </RadzenFormField>
        <RadzenRequiredValidator Component="Amount" Text="Required" />

        <RadzenFormField Text="Date" Variant="Variant.Outlined">
            <RadzenDatePicker @bind-Value="TransactionModel.TransactionDate" Name="TransactionDate" />
        </RadzenFormField>

        <RadzenButton ButtonType="ButtonType.Submit" Text="Save" Icon="save" ButtonStyle="ButtonStyle.Primary" Style="width: 100%" IsBusy="@isProcessing" />
    </RadzenStack>
</RadzenTemplateForm>

@code {
    [Parameter] public Guid? TransactionId { get; set; }
    public TransactionUpdateDto TransactionModel { get; set; } = new() { TransactionDate = DateTime.Today };

    private List<CategoryViewDto> allCategories = new();
    private List<CategoryViewDto> mainCategories = new();
    private List<CategoryViewDto> filteredSubCategories = new();
    private Guid? selectedMainCategoryId;
    private bool isProcessing = false;

    protected override async Task OnInitializedAsync()
    {
        var cats = await Http.GetFromJsonAsync<List<CategoryViewDto>>("api/categories");
        if (cats != null)
        {
            allCategories = cats;
            mainCategories = allCategories.Where(c => c.ParentCategoryId == null).ToList();
        }

        if (TransactionId != null)
        {
            var t = await Http.GetFromJsonAsync<TransactionViewDto>($"api/transaction/{TransactionId}");
            if (t != null)
            {
                // Map basic fields
                TransactionModel = new TransactionUpdateDto { Amount = t.Amount, Description = t.Description, Merchant = t.Merchant, PaymentMethod = t.PaymentMethod, TransactionDate = t.TransactionDate, Type = t.Type, CategoryId = t.CategoryId };

                // Find parent to pre-select dropdowns
                var currentCat = allCategories.FirstOrDefault(c => c.Id == t.CategoryId);
                if (currentCat?.ParentCategoryId != null)
                {
                    selectedMainCategoryId = currentCat.ParentCategoryId;
                    OnMainCategoryChange(); // Filter subs
                }
            }
        }
    }

    private void OnMainCategoryChange()
    {
        if (selectedMainCategoryId != null)
        {
            filteredSubCategories = allCategories.Where(c => c.ParentCategoryId == selectedMainCategoryId).ToList();
        }
        else
        {
            filteredSubCategories.Clear();
        }
    }

    private async Task OnSubmit(TransactionUpdateDto args)
    {
        isProcessing = true;
        try
        {
            HttpResponseMessage response;
            if (TransactionId == null)
            {
                var createDto = new TransactionCreateDto
                {
                    Amount = TransactionModel.Amount,
                    Type = TransactionModel.Type,
                    Description = TransactionModel.Description,
                    Merchant = TransactionModel.Merchant,
                    PaymentMethod = TransactionModel.PaymentMethod,
                    TransactionDate = TransactionModel.TransactionDate,
                    CategoryId = TransactionModel.CategoryId
                };
                response = await Http.PostAsJsonAsync("api/transaction", createDto);
            }
            else
            {
                response = await Http.PutAsJsonAsync($"api/transaction/{TransactionId}", TransactionModel);
            }

            if (response.IsSuccessStatusCode) { DialogService.Close(true); NotificationService.Notify(NotificationSeverity.Success, "Saved!"); }
            else { NotificationService.Notify(NotificationSeverity.Error, "Error", await response.Content.ReadAsStringAsync()); }
        }
        finally { isProcessing = false; }
    }
}