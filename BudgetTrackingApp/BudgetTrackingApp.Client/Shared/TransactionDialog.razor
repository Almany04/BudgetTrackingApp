@inject HttpClient Http
@inject DialogService DialogService
@inject NotificationService NotificationService
@using BudgetTrackingApp.Shared.Dtos.Transactions
@using BudgetTrackingApp.Shared.Dtos.Category
@using BudgetTrackingApp.Shared.Enums

<RadzenTemplateForm TItem="TransactionUpdateDto" Data="@TransactionModel" Submit="@OnSubmit">
    <RadzenStack Spacing="1rem">

        @if (ForcedType.HasValue)
        {
            <RadzenAlert Severity="NotificationSeverity.Info" AllowClose="false" Variant="Variant.Flat" Shade="Shade.Lighter">
                Adding <strong>@ForcedType.Value</strong>
            </RadzenAlert>
        }

        <RadzenRow>
            @if (!ForcedType.HasValue)
            {
                <RadzenColumn Size="6">
                    <RadzenFormField Text="Type" Variant="Variant.Outlined" Style="width:100%">
                        <RadzenDropDown @bind-Value="TransactionModel.Type" Data="@transactionTypes" TextProperty="Name" ValueProperty="Value" Name="Type" />
                    </RadzenFormField>
                </RadzenColumn>
            }

            <RadzenColumn Size="@(ForcedType.HasValue ? 12 : 6)">
                <RadzenFormField Text="Payment" Variant="Variant.Outlined" Style="width:100%">
                    <RadzenDropDown @bind-Value="TransactionModel.PaymentMethod" Data="@filteredPaymentMethods" TextProperty="Name" ValueProperty="Value" Name="PaymentMethod" />
                </RadzenFormField>
            </RadzenColumn>
        </RadzenRow>

        @if (TransactionModel.Type == TransactionType.Expense)
        {
            <RadzenFormField Text="Merchant (Shop Name)" Variant="Variant.Outlined">
                <RadzenTextBox @bind-Value="TransactionModel.Merchant" Name="Merchant" Placeholder="e.g. Spar, Tesco" Style="width: 100%" />
            </RadzenFormField>
            <RadzenRequiredValidator Component="Merchant" Text="Required" />
        }

        @if (TransactionModel.Type != TransactionType.Saving)
        {
            <RadzenFormField Text="Main Category" Variant="Variant.Outlined">
                <RadzenDropDown Data="@mainCategories" TextProperty="Name" ValueProperty="Id"
                                @bind-Value="selectedMainCategoryId" Change="@OnMainCategoryChange"
                                Placeholder="Select Group..." Style="width: 100%" />
            </RadzenFormField>

            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.End" Gap="0.5rem">
                <RadzenFormField Text="Sub Item" Variant="Variant.Outlined" Style="flex-grow: 1;">
                    <RadzenDropDown Data="@filteredSubCategories" TextProperty="Name" ValueProperty="Id"
                                    @bind-Value="TransactionModel.CategoryId" Name="CategoryId"
                                    Placeholder="Select..." Disabled="@(selectedMainCategoryId == null)" Style="width: 100%" />
                </RadzenFormField>
                <RadzenButton Icon="add" ButtonStyle="ButtonStyle.Secondary" ToolTip="New Sub-Item"
                              Disabled="@(selectedMainCategoryId == null)" Click="@OpenCreateSubCategoryDialog" />
            </RadzenStack>
            <RadzenRequiredValidator Component="CategoryId" Text="Required" />
        }

        <RadzenFormField Text="Amount (HUF)" Variant="Variant.Outlined">
            <RadzenNumeric @bind-Value="TransactionModel.Amount" Name="Amount" Min="1" />
        </RadzenFormField>
        <RadzenRequiredValidator Component="Amount" Text="Required" />

        <RadzenFormField Text="Date" Variant="Variant.Outlined">
            <RadzenDatePicker @bind-Value="TransactionModel.TransactionDate" Name="TransactionDate" />
        </RadzenFormField>

        <RadzenFormField Text="Description" Variant="Variant.Outlined">
            <RadzenTextArea @bind-Value="TransactionModel.Description" Rows="2" />
        </RadzenFormField>

        <RadzenButton ButtonType="ButtonType.Submit" Text="Save" Icon="save" ButtonStyle="ButtonStyle.Primary" Style="width: 100%" IsBusy="@isProcessing" />
    </RadzenStack>
</RadzenTemplateForm>

@code {
    [Parameter] public Guid? TransactionId { get; set; }
    [Parameter] public TransactionType? ForcedType { get; set; }

    public TransactionUpdateDto TransactionModel { get; set; } = new() { TransactionDate = DateTime.Today };

    public class EnumItem<T> { public string Name { get; set; } public T Value { get; set; } }
    private List<EnumItem<TransactionType>> transactionTypes = Enum.GetValues(typeof(TransactionType)).Cast<TransactionType>().Select(e => new EnumItem<TransactionType> { Name = e.ToString(), Value = e }).ToList();
    private List<EnumItem<PaymentMethod>> allPaymentMethods = Enum.GetValues(typeof(PaymentMethod)).Cast<PaymentMethod>().Select(e => new EnumItem<PaymentMethod> { Name = e.ToString(), Value = e }).ToList();

    private IEnumerable<EnumItem<PaymentMethod>> filteredPaymentMethods =>
        (TransactionModel.Type == TransactionType.Saving)
            ? allPaymentMethods.Where(p => p.Value == PaymentMethod.Card || p.Value == PaymentMethod.Cash)
            : allPaymentMethods;

    private List<CategoryViewDto> allCategories = new();
    private List<CategoryViewDto> mainCategories = new();
    private List<CategoryViewDto> filteredSubCategories = new();
    private Guid? selectedMainCategoryId;
    private bool isProcessing = false;

    protected override async Task OnInitializedAsync()
    {
        if (ForcedType.HasValue) TransactionModel.Type = ForcedType.Value;
        await LoadCategoriesAsync();

        if (TransactionId != null)
        {
            var t = await Http.GetFromJsonAsync<TransactionViewDto>($"api/transaction/{TransactionId}");
            if (t != null)
            {
                TransactionModel = new TransactionUpdateDto { Amount = t.Amount, Description = t.Description, Merchant = t.Merchant, PaymentMethod = t.PaymentMethod, TransactionDate = t.TransactionDate, Type = t.Type, CategoryId = t.CategoryId };
                var currentCat = allCategories.FirstOrDefault(c => c.Id == t.CategoryId);
                if (currentCat?.ParentCategoryId != null)
                {
                    selectedMainCategoryId = currentCat.ParentCategoryId;
                    OnMainCategoryChange();
                }
            }
        }
    }

    private async Task LoadCategoriesAsync()
    {
        var cats = await Http.GetFromJsonAsync<List<CategoryViewDto>>("api/categories");
        if (cats != null)
        {
            allCategories = cats;
            mainCategories = allCategories.Where(c => c.ParentCategoryId == null).OrderBy(c => c.Name).ToList();
            if (selectedMainCategoryId != null) OnMainCategoryChange();
        }
    }

    private void OnMainCategoryChange()
    {
        if (selectedMainCategoryId != null)
            filteredSubCategories = allCategories.Where(c => c.ParentCategoryId == selectedMainCategoryId).OrderBy(c => c.Name).ToList();
        else
            filteredSubCategories.Clear();
    }

    private async Task OpenCreateSubCategoryDialog()
    {
        if (selectedMainCategoryId == null) return;
        var model = new CategoryCreateDto { ParentCategoryId = selectedMainCategoryId };
        var result = await DialogService.OpenAsync<CategoryDialog>("New Sub Item", new Dictionary<string, object> { { "CategoryModel", model } }, new DialogOptions() { Width = "400px", CssClass = "xtract-card" });
        if (result == true) { await LoadCategoriesAsync(); NotificationService.Notify(NotificationSeverity.Success, "Created", "Added!"); }
    }

    private async Task OnSubmit(TransactionUpdateDto args)
    {
        isProcessing = true;
        try
        {
           
            if (TransactionModel.Type == TransactionType.Saving)
            {
                var savingCat = allCategories.FirstOrDefault(c => c.Name == "General Savings");
                if (savingCat == null)
                {
                    
                    var createResponse = await Http.PostAsJsonAsync("api/categories", new CategoryCreateDto { Name = "General Savings" });
                    if (createResponse.IsSuccessStatusCode)
                    {
                        var newCats = await Http.GetFromJsonAsync<List<CategoryViewDto>>("api/categories");
                        savingCat = newCats?.FirstOrDefault(c => c.Name == "General Savings");
                    }
                }

                if (savingCat != null) TransactionModel.CategoryId = savingCat.Id;
                else { NotificationService.Notify(NotificationSeverity.Error, "Error", "Could not initialize Savings category."); return; }
            }
           

            HttpResponseMessage response;
            if (TransactionId == null)
            {
                var createDto = new TransactionCreateDto { Amount = TransactionModel.Amount, Type = TransactionModel.Type, Description = TransactionModel.Description, Merchant = TransactionModel.Merchant, PaymentMethod = TransactionModel.PaymentMethod, TransactionDate = TransactionModel.TransactionDate, CategoryId = TransactionModel.CategoryId };
                response = await Http.PostAsJsonAsync("api/transaction", createDto);
            }
            else
            {
                response = await Http.PutAsJsonAsync($"api/transaction/{TransactionId}", TransactionModel);
            }

            if (response.IsSuccessStatusCode) { DialogService.Close(true); NotificationService.Notify(NotificationSeverity.Success, "Saved!"); }
            else { NotificationService.Notify(NotificationSeverity.Error, "Error", await response.Content.ReadAsStringAsync()); }
        }
        finally { isProcessing = false; }
    }
}