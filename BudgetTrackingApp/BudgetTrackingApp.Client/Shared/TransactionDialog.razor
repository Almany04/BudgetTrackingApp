@inject HttpClient Http
@inject DialogService DialogService
@inject NotificationService NotificationService
@using BudgetTrackingApp.Shared.Dtos.Transactions
@using BudgetTrackingApp.Shared.Dtos.Category
@using BudgetTrackingApp.Shared.Enums

<RadzenTabs RenderMode="TabRenderMode.Client">
    <Tabs>
        @* --- TAB 1: SINGLE ITEM --- *@
        <RadzenTabsItem Text="Single Item" Icon="receipt">
            <RadzenTemplateForm TItem="TransactionUpdateDto" Data="@TransactionModel" Submit="@OnSubmitSingle">
                <RadzenStack Spacing="1rem">

                    @* TYPE & PAYMENT *@
                    <RadzenRow>
                        @if (!ForcedType.HasValue)
                        {
                            <RadzenColumn Size="6">
                                <RadzenFormField Text="Type" Variant="Variant.Outlined" Style="width:100%">
                                    <RadzenDropDown @bind-Value="TransactionModel.Type" Data="@transactionTypes" TextProperty="Name" ValueProperty="Value" Name="Type" />
                                </RadzenFormField>
                            </RadzenColumn>
                        }
                        <RadzenColumn Size="@(ForcedType.HasValue ? 12 : 6)">
                            <RadzenFormField Text="Payment" Variant="Variant.Outlined" Style="width:100%">
                                <RadzenDropDown @bind-Value="TransactionModel.PaymentMethod" Data="@allPaymentMethods" TextProperty="Name" ValueProperty="Value" Name="PaymentMethod" />
                            </RadzenFormField>
                        </RadzenColumn>
                    </RadzenRow>

                    @* --- COUPLE FEATURES (SPLIT LOGIC) --- *@
                    <RadzenCard Style="background: rgba(255,255,255,0.05); padding: 1rem;">
                        <RadzenStack Gap="1rem">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenLabel Text="Split Expense?" Component="Split" Style="color: var(--text-secondary); font-weight: 600;" />
                                <RadzenSwitch @bind-Value="TransactionModel.IsSplit" Name="Split" Change="@UpdateRatio" />
                            </RadzenStack>

                            @if (TransactionModel.IsSplit)
                            {
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                    <span style="color: #a78bfa; width: 70px; font-size: 0.8rem;">Girlfriend</span>
                                    <RadzenSlider TValue="decimal" @bind-Value="mySharePercentDisplay" Min="0" Max="100" Step="5" Style="flex-grow: 1;" Change="@UpdateRatio" />
                                    <span style="color: #22c55e; width: 70px; text-align: right; font-size: 0.8rem;">Me (@mySharePercentDisplay.ToString("0")%)</span>
                                </RadzenStack>

                                <RadzenText TextStyle="TextStyle.Caption" Style="text-align: center; color: var(--text-secondary);">
                                    Who paid initially?
                                </RadzenText>
                                <RadzenSelectBar @bind-Value="TransactionModel.PaidBy" TValue="PaidBy" Size="ButtonSize.Small" Style="width: 100%;">
                                    <Items>
                                        <RadzenSelectBarItem Text="Me" Value="PaidBy.Me" />
                                        <RadzenSelectBarItem Text="Girlfriend" Value="PaidBy.Partner" />
                                    </Items>
                                </RadzenSelectBar>
                            }
                            else
                            {
                                <RadzenFormField Text="Paid By" Variant="Variant.Outlined">
                                    <RadzenDropDown @bind-Value="TransactionModel.PaidBy" Data="@paidByOptions" TextProperty="Name" ValueProperty="Value" />
                                </RadzenFormField>
                            }
                        </RadzenStack>
                    </RadzenCard>

                    @* REST OF FORM *@
                    @if (TransactionModel.Type == TransactionType.Expense)
                    {
                        <RadzenFormField Text="Merchant" Variant="Variant.Outlined">
                            <RadzenTextBox @bind-Value="TransactionModel.Merchant" Name="Merchant" Placeholder="e.g. Spar" Style="width: 100%" />
                        </RadzenFormField>
                    }

                    @if (TransactionModel.Type == TransactionType.Saving)
                    {
                        <RadzenFormField Text="Link to Goal" Variant="Variant.Outlined">
                            <RadzenDropDown Data="@savingGoals" TextProperty="Name" ValueProperty="Id" @bind-Value="TransactionModel.SavingGoalId" Placeholder="None (General Savings)" Style="width: 100%" />
                        </RadzenFormField>
                    }

                    @if (TransactionModel.Type != TransactionType.Saving)
                    {
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.End" Gap="0.5rem">
                            <RadzenFormField Text="Main Category" Variant="Variant.Outlined" Style="flex-grow: 1;">
                                <RadzenDropDown Data="@mainCategories" TextProperty="Name" ValueProperty="Id"
                                                @bind-Value="selectedMainCategoryId" Change="@OnMainCategoryChange"
                                                Placeholder="Select Group..." Style="width: 100%" />
                            </RadzenFormField>
                            <RadzenButton Icon="add_circle_outline" ButtonStyle="ButtonStyle.Primary"
                                          ToolTip="New Main Group"
                                          Click="@OpenCreateMainCategoryDialog" />
                        </RadzenStack>

                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.End" Gap="0.5rem">
                            <RadzenFormField Text="Sub Item" Variant="Variant.Outlined" Style="flex-grow: 1;">
                                <RadzenDropDown Data="@filteredSubCategories" TextProperty="Name" ValueProperty="Id"
                                                @bind-Value="TransactionModel.CategoryId" Name="CategoryId"
                                                Placeholder="Select..." Disabled="@(selectedMainCategoryId == null)" Style="width: 100%" />
                            </RadzenFormField>
                            <RadzenButton Icon="add" ButtonStyle="ButtonStyle.Secondary" ToolTip="New Sub-Item"
                                          Disabled="@(selectedMainCategoryId == null)" Click="@OpenCreateSubCategoryDialog" />
                        </RadzenStack>
                        <RadzenRequiredValidator Component="CategoryId" Text="Required" />
                    }

                    <RadzenFormField Text="Amount (HUF)" Variant="Variant.Outlined">
                        <RadzenNumeric @bind-Value="TransactionModel.Amount" Name="Amount" Min="1" />
                    </RadzenFormField>
                    <RadzenRequiredValidator Component="Amount" Text="Required" />

                    <RadzenFormField Text="Date" Variant="Variant.Outlined">
                        <RadzenDatePicker @bind-Value="TransactionModel.TransactionDate" Name="TransactionDate" />
                    </RadzenFormField>

                    <RadzenFormField Text="Description" Variant="Variant.Outlined">
                        <RadzenTextArea @bind-Value="TransactionModel.Description" Rows="2" />
                    </RadzenFormField>

                    <RadzenButton ButtonType="ButtonType.Submit" Text="Save Transaction" Icon="save" ButtonStyle="ButtonStyle.Primary" Style="width: 100%" IsBusy="@isProcessing" />
                </RadzenStack>
            </RadzenTemplateForm>
        </RadzenTabsItem>

        @* --- TAB 2: BULK RECEIPT (RESTORED & UPDATED) --- *@
        <RadzenTabsItem Text="Receipt (Bulk)" Icon="playlist_add">
            <RadzenStack Spacing="1rem">
                <RadzenCard Class="rz-p-2" Style="background: rgba(255,255,255,0.05);">
                    <RadzenRow RowGap="1rem">
                        <RadzenColumn Size="6">
                            <RadzenText TextStyle="TextStyle.Subtitle2">Merchant</RadzenText>
                            <RadzenTextBox @bind-Value="BulkModel.Merchant" Placeholder="e.g. Tesco Receipt" Style="width:100%" />
                        </RadzenColumn>
                        <RadzenColumn Size="6">
                            <RadzenText TextStyle="TextStyle.Subtitle2">Date</RadzenText>
                            <RadzenDatePicker @bind-Value="BulkModel.TransactionDate" Style="width:100%" />
                        </RadzenColumn>
                        <RadzenColumn Size="6">
                            <RadzenText TextStyle="TextStyle.Subtitle2">Payment</RadzenText>
                            <RadzenDropDown @bind-Value="BulkModel.PaymentMethod" Data="@allPaymentMethods" TextProperty="Name" ValueProperty="Value" Style="width:100%" />
                        </RadzenColumn>
                        <RadzenColumn Size="6" Class="rz-text-align-right">
                            <RadzenText TextStyle="TextStyle.Subtitle2">Total</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5" Style="color: #22c55e">
                                @BulkModel.Items.Sum(x => x.Amount).ToString("C0")
                            </RadzenText>
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenCard>

                @* --- BULK SPLIT SETTINGS --- *@
                <RadzenCard Style="background: rgba(255,255,255,0.05); padding: 1rem;">
                    <RadzenStack Gap="0.5rem">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                            <RadzenLabel Text="Split Entire Receipt?" Style="color: var(--text-secondary); font-weight: 600;" />
                            <RadzenSwitch @bind-Value="BulkModel.IsSplit" Change="@UpdateBulkRatio" />
                        </RadzenStack>

                        @if (BulkModel.IsSplit)
                        {
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                <span style="color: #a78bfa; width: 70px; font-size: 0.8rem;">Girlfriend</span>
                                <RadzenSlider TValue="decimal" @bind-Value="bulkSharePercentDisplay" Min="0" Max="100" Step="5" Style="flex-grow: 1;" Change="@UpdateBulkRatio" />
                                <span style="color: #22c55e; width: 70px; text-align: right; font-size: 0.8rem;">Me (@bulkSharePercentDisplay.ToString("0")%)</span>
                            </RadzenStack>

                            <RadzenSelectBar @bind-Value="BulkModel.PaidBy" TValue="PaidBy" Size="ButtonSize.Small" Style="width: 100%;">
                                <Items>
                                    <RadzenSelectBarItem Text="Me" Value="PaidBy.Me" />
                                    <RadzenSelectBarItem Text="Girlfriend" Value="PaidBy.Partner" />
                                </Items>
                            </RadzenSelectBar>
                        }
                        else
                        {
                            <RadzenFormField Text="Paid By" Variant="Variant.Outlined">
                                <RadzenDropDown @bind-Value="BulkModel.PaidBy" Data="@paidByOptions" TextProperty="Name" ValueProperty="Value" />
                            </RadzenFormField>
                        }
                    </RadzenStack>
                </RadzenCard>

                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.End" Gap="0.5rem">
                    <RadzenFormField Text="Item Name" Variant="Variant.Outlined" Style="flex-grow:1">
                        <RadzenTextBox @bind-Value="newItem.Description" Placeholder="e.g. Milk" />
                    </RadzenFormField>
                    <RadzenFormField Text="Cost" Variant="Variant.Outlined" Style="width:100px">
                        <RadzenNumeric @bind-Value="newItem.Amount" Min="0" />
                    </RadzenFormField>
                    <RadzenFormField Text="Category" Variant="Variant.Outlined" Style="width:180px">
                        <RadzenDropDown Data="@allSubCategoriesFlat" TextProperty="Name" ValueProperty="Id"
                                        @bind-Value="newItem.CategoryId" Placeholder="Cat..."
                                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" AllowFiltering="true" />
                    </RadzenFormField>
                    <RadzenButton Icon="add" ButtonStyle="ButtonStyle.Success" Click="@AddBulkItem" Disabled="@(newItem.Amount <= 0 || newItem.CategoryId == Guid.Empty)" />
                </RadzenStack>

                <RadzenDataGrid @ref="bulkGrid" Data="@BulkModel.Items" TItem="TransactionItemDto" Density="Density.Compact" AllowPaging="true" PageSize="5">
                    <Columns>
                        <RadzenDataGridColumn TItem="TransactionItemDto" Property="Description" Title="Item" />
                        <RadzenDataGridColumn TItem="TransactionItemDto" Property="Amount" Title="Cost">
                            <Template Context="d">@d.Amount.ToString("N0")</Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="TransactionItemDto" Title="Category">
                            <Template Context="d">
                                @(allCategories.FirstOrDefault(c => c.Id == d.CategoryId)?.Name ?? "?")
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="TransactionItemDto" Title="" Width="60px">
                            <Template Context="d">
                                <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.ExtraSmall" Click="@(() => RemoveBulkItem(d))" />
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>

                <RadzenButton Text="@($"Save Receipt ({BulkModel.Items.Count} items)")" Icon="done_all"
                              ButtonStyle="ButtonStyle.Primary" Click="@OnSubmitBulk"
                              Disabled="@(!BulkModel.Items.Any())" IsBusy="@isProcessing" />
            </RadzenStack>
        </RadzenTabsItem>
    </Tabs>
</RadzenTabs>

@code {
    [Parameter] public Guid? TransactionId { get; set; }
    [Parameter] public TransactionType? ForcedType { get; set; }

    public TransactionUpdateDto TransactionModel { get; set; } = new() { TransactionDate = DateTime.Today };

    // Bulk Model
    public BulkTransactionCreateDto BulkModel { get; set; } = new() { TransactionDate = DateTime.Today };
    private TransactionItemDto newItem = new();
    private RadzenDataGrid<TransactionItemDto> bulkGrid;

    // Ratios (0-100 for UI)
    private decimal mySharePercentDisplay = 50;
    private decimal bulkSharePercentDisplay = 50;

    // Lists
    public class EnumItem<T> { public string Name { get; set; } public T Value { get; set; } }
    private List<EnumItem<TransactionType>> transactionTypes = Enum.GetValues(typeof(TransactionType)).Cast<TransactionType>().Select(e => new EnumItem<TransactionType> { Name = e.ToString(), Value = e }).ToList();
    private List<EnumItem<PaymentMethod>> allPaymentMethods = Enum.GetValues(typeof(PaymentMethod)).Cast<PaymentMethod>().Select(e => new EnumItem<PaymentMethod> { Name = e.ToString(), Value = e }).ToList();

    private List<EnumItem<PaidBy>> paidByOptions = new List<EnumItem<PaidBy>>
    {
        new EnumItem<PaidBy> { Name = "Me", Value = PaidBy.Me },
        new EnumItem<PaidBy> { Name = "Girlfriend", Value = PaidBy.Partner }
    };

    private List<CategoryViewDto> allCategories = new();
    private List<CategoryViewDto> mainCategories = new();
    private List<CategoryViewDto> filteredSubCategories = new();
    private List<CategoryViewDto> allSubCategoriesFlat = new(); // For Bulk Dropdown
    private List<SavingGoalDto> savingGoals = new();

    private Guid? selectedMainCategoryId;
    private bool isProcessing = false;

    protected override async Task OnInitializedAsync()
    {
        if (ForcedType.HasValue) TransactionModel.Type = ForcedType.Value;

        await LoadCategoriesAsync();
        await LoadGoalsAsync();

        if (TransactionId != null)
        {
            var t = await Http.GetFromJsonAsync<TransactionViewDto>($"api/transaction/{TransactionId}");
            if (t != null)
            {
                TransactionModel = new TransactionUpdateDto
                {
                    Amount = t.Amount,
                    Description = t.Description,
                    Merchant = t.Merchant,
                    PaymentMethod = t.PaymentMethod,
                    TransactionDate = t.TransactionDate,
                    Type = t.Type,
                    CategoryId = t.CategoryId,
                    PaidBy = t.PaidBy,
                    IsSplit = t.IsSplit,
                    MyShareRatio = t.MyShareRatio,
                    SavingGoalId = t.SavingGoalId
                };
                mySharePercentDisplay = TransactionModel.MyShareRatio * 100;

                var currentCat = allCategories.FirstOrDefault(c => c.Id == t.CategoryId);
                if (currentCat?.ParentCategoryId != null)
                {
                    selectedMainCategoryId = currentCat.ParentCategoryId;
                    OnMainCategoryChange();
                }
            }
        }
    }

    private void UpdateRatio()
    {
        if (TransactionModel.IsSplit)
            TransactionModel.MyShareRatio = mySharePercentDisplay / 100m;
        else
        {
            TransactionModel.MyShareRatio = 1.0m;
            // If not split, paidBy logic remains as selected in dropdown (default Me)
        }
    }

    private void UpdateBulkRatio()
    {
        if (BulkModel.IsSplit)
            BulkModel.MyShareRatio = bulkSharePercentDisplay / 100m;
        else
        {
            BulkModel.MyShareRatio = 1.0m;
            // PaidBy resets if needed, or stays as is
        }
    }

    private async Task LoadCategoriesAsync()
    {
        var cats = await Http.GetFromJsonAsync<List<CategoryViewDto>>("api/categories");
        if (cats != null)
        {
            allCategories = cats;
            mainCategories = allCategories.Where(c => c.ParentCategoryId == null).OrderBy(c => c.Name).ToList();
            // Flatten subcategories for bulk add
            allSubCategoriesFlat = allCategories.Where(c => c.ParentCategoryId != null).OrderBy(c => c.Name).ToList();
        }
    }

    private async Task LoadGoalsAsync()
    {
        try { savingGoals = await Http.GetFromJsonAsync<List<SavingGoalDto>>("api/features/goals") ?? new(); } catch { }
    }

    private void OnMainCategoryChange()
    {
        if (selectedMainCategoryId != null)
            filteredSubCategories = allCategories.Where(c => c.ParentCategoryId == selectedMainCategoryId).OrderBy(c => c.Name).ToList();
        else
            filteredSubCategories.Clear();
    }

    private async Task OpenCreateMainCategoryDialog()
    {
        var model = new CategoryCreateDto { ParentCategoryId = null };
        var result = await DialogService.OpenAsync<CategoryDialog>("New Main Group",
            new Dictionary<string, object> { { "CategoryModel", model } },
            new DialogOptions() { Width = "400px", CssClass = "xtract-card" });
        if (result == true) await LoadCategoriesAsync();
    }

    private async Task OpenCreateSubCategoryDialog()
    {
        if (selectedMainCategoryId == null) return;
        var model = new CategoryCreateDto { ParentCategoryId = selectedMainCategoryId };
        var result = await DialogService.OpenAsync<CategoryDialog>("New Sub Item", new Dictionary<string, object> { { "CategoryModel", model } }, new DialogOptions() { Width = "400px", CssClass = "xtract-card" });
        if (result == true) await LoadCategoriesAsync();
    }

    private async Task OnSubmitSingle(TransactionUpdateDto args)
    {
        isProcessing = true;
        try
        {
            UpdateRatio();

            HttpResponseMessage response;
            if (TransactionId == null)
            {
                var createDto = new TransactionCreateDto
                {
                    Amount = TransactionModel.Amount,
                    Type = TransactionModel.Type,
                    Description = TransactionModel.Description,
                    Merchant = TransactionModel.Merchant,
                    PaymentMethod = TransactionModel.PaymentMethod,
                    TransactionDate = TransactionModel.TransactionDate,
                    CategoryId = TransactionModel.CategoryId,
                    PaidBy = TransactionModel.PaidBy,
                    IsSplit = TransactionModel.IsSplit,
                    MyShareRatio = TransactionModel.MyShareRatio,
                    SavingGoalId = TransactionModel.SavingGoalId
                };
                response = await Http.PostAsJsonAsync("api/transaction", createDto);
            }
            else
            {
                response = await Http.PutAsJsonAsync($"api/transaction/{TransactionId}", TransactionModel);
            }

            if (response.IsSuccessStatusCode) { DialogService.Close(true); NotificationService.Notify(NotificationSeverity.Success, "Saved!"); }
            else { NotificationService.Notify(NotificationSeverity.Error, "Error", await response.Content.ReadAsStringAsync()); }
        }
        finally { isProcessing = false; }
    }

    // --- Bulk Logic ---
    private void AddBulkItem()
    {
        if (newItem.Amount > 0 && newItem.CategoryId != Guid.Empty)
        {
            BulkModel.Items.Add(new TransactionItemDto
            {
                Amount = newItem.Amount,
                Description = newItem.Description,
                CategoryId = newItem.CategoryId,
                Type = TransactionType.Expense
            });
            newItem = new TransactionItemDto();
            if (bulkGrid != null) bulkGrid.Reload();
        }
    }

    private void RemoveBulkItem(TransactionItemDto item)
    {
        BulkModel.Items.Remove(item);
        if (bulkGrid != null) bulkGrid.Reload();
    }

    private async Task OnSubmitBulk()
    {
        isProcessing = true;
        try
        {
            UpdateBulkRatio();
            var response = await Http.PostAsJsonAsync("api/transaction/bulk", BulkModel);
            if (response.IsSuccessStatusCode)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Receipt Saved", $"{BulkModel.Items.Count} items added.");
                DialogService.Close(true);
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", await response.Content.ReadAsStringAsync());
            }
        }
        catch (Exception ex) { NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message); }
        finally { isProcessing = false; }
    }
}