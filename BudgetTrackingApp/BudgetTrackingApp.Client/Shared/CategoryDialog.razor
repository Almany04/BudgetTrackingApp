@using BudgetTrackingApp.Shared.Dtos.Category
@using MudBlazor
@using Microsoft.AspNetCore.Components.Forms
@inject HttpClient Http
@inject ISnackbar Snackbar

<EditForm Model="CategoryModel" OnValidSubmit="HandleSave">
    <DataAnnotationsValidator />
    <MudDialog>
        <DialogContent>
            @if (CategoryModel is CategoryCreateDto createModel)
            {
                <MudTextField Label="Kategória Név"
                              Class="mt-3"
                              @bind-Value="createModel.Name"
                              For="@(() => createModel.Name)"
                              AutoFocus="true" />
            }
            else if (CategoryModel is CategoryUpdateDto updateModel)
            {
                <MudTextField Label="Kategória Név"
                              Class="mt-3"
                              @bind-Value="updateModel.Name"
                              For="@(() => updateModel.Name)"
                              AutoFocus="true" />
            }
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="Cancel">Mégse</MudButton>
            <MudButton ButtonType="ButtonType.Submit"
                       Color="Color.Primary"
                       Variant="Variant.Filled"
                       Disabled="isProcessing">
                @if (isProcessing)
                {
                    <MudProgressCircular Indeterminate="true" Size="Size.Small" />
                }
                else
                {
                    <span>Mentés</span>
                }
            </MudButton>
        </DialogActions>
    </MudDialog>
</EditForm>

@code {
    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; }

    [Parameter]
    public object CategoryModel { get; set; } = new();

    [Parameter]
    public Guid? CategoryId { get; set; }

    private bool isProcessing = false;

    private async Task HandleSave()
    {
        isProcessing = true;
        try
        {
            HttpResponseMessage response;
            if (CategoryId == null && CategoryModel is CategoryCreateDto createDto)
            {
                response = await Http.PostAsJsonAsync("api/categories", createDto);
            }
            else if (CategoryId != null && CategoryModel is CategoryUpdateDto updateDto)
            {
                response = await Http.PutAsJsonAsync($"api/categories/{CategoryId}", updateDto);
            }
            else
            {
                throw new InvalidOperationException("Érvénytelen modell vagy hiányzó ID.");
            }

            if (response.IsSuccessStatusCode)
            {
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Hiba mentés közben: {error}", Severity.Error, config =>
                {
                    config.ShowCloseIcon = true;
                    config.VisibleStateDuration = 5000;
                });
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Váratlan hiba: {ex.Message}", Severity.Error, config =>
            {
                config.ShowCloseIcon = true;
                config.VisibleStateDuration = 5000;
            });
        }
        finally
        {
            isProcessing = false;
        }
    }

    void Cancel() => MudDialog.Cancel();
}