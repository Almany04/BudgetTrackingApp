@using BudgetTrackingApp.Shared.Dtos.Category
@inject HttpClient Http
@inject DialogService DialogService
@inject NotificationService NotificationService

<RadzenTemplateForm TItem="object" Data="@CategoryModel" Submit="@OnSubmit">
    <RadzenStack Spacing="3">
        <RadzenFormField Text="Category Name" Variant="Variant.Outlined">
            @if (CategoryModel is CategoryCreateDto createModel)
            {
                <RadzenTextBox @bind-Value="createModel.Name" Name="Name" style="width: 100%;" />
            }
            else if (CategoryModel is CategoryUpdateDto updateModel)
            {
                <RadzenTextBox @bind-Value="updateModel.Name" Name="Name" style="width: 100%;" />
            }
        </RadzenFormField>
        <RadzenRequiredValidator Component="Name" Text="Name is required" />

        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="1rem" Class="rz-mt-4">
            <RadzenButton ButtonType="ButtonType.Submit" Text="Save" ButtonStyle="ButtonStyle.Primary" Disabled="@isProcessing" IsBusy="@isProcessing" />
            <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@(() => DialogService.Close(false))" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>

@code {
    [Parameter] public object CategoryModel { get; set; } = new();
    [Parameter] public Guid? CategoryId { get; set; }
    private bool isProcessing = false;

    private async Task OnSubmit(object args)
    {
        await HandleSave();
    }

    private async Task HandleSave()
    {
        isProcessing = true;
        try
        {
            HttpResponseMessage response;
            if (CategoryId == null && CategoryModel is CategoryCreateDto createDto)
            {
                response = await Http.PostAsJsonAsync("api/categories", createDto);
            }
            else if (CategoryId != null && CategoryModel is CategoryUpdateDto updateDto)
            {
                response = await Http.PutAsJsonAsync($"api/categories/{CategoryId}", updateDto);
            }
            else
            {
                throw new InvalidOperationException("Invalid model.");
            }

            if (response.IsSuccessStatusCode)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Category saved!");
                DialogService.Close(true);
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                NotificationService.Notify(NotificationSeverity.Error, "Error", error);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
        finally
        {
            isProcessing = false;
        }
    }
}