@page "/transactions"
@attribute [Authorize]
@inject HttpClient Http
@inject DialogService DialogService
@inject NotificationService NotificationService
@using BudgetTrackingApp.Shared.Dtos.Transactions
@using BudgetTrackingApp.Shared.Enums

<PageTitle>Transactions</PageTitle>

<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Class="rz-mb-4">
    <RadzenText TextStyle="TextStyle.H4" Class="rz-m-0" Style="color: white;">Transactions</RadzenText>
    <RadzenButton Text="Add New" Icon="add_circle" ButtonStyle="ButtonStyle.Primary" Click="@(args => OpenTransactionDialog(null))" />
</RadzenStack>

<RadzenCard Class="xtract-card rz-mb-4">
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.End" Gap="1rem" Wrap="FlexWrap.Wrap">
        <RadzenFormField Text="Start Date" Variant="Variant.Outlined" Style="color: white;">
            <RadzenDatePicker @bind-Value="startDate" DateFormat="yyyy.MM.dd" />
        </RadzenFormField>
        <RadzenFormField Text="End Date" Variant="Variant.Outlined">
            <RadzenDatePicker @bind-Value="endDate" DateFormat="yyyy.MM.dd" />
        </RadzenFormField>
        <RadzenButton Text="Refresh List" Click="@(args => LoadTransactionsAsync())" Icon="refresh" ButtonStyle="ButtonStyle.Secondary" />
    </RadzenStack>
</RadzenCard>

<RadzenDataGrid Data="@transactions" TItem="TransactionViewDto"
                AllowPaging="true" PageSize="10"
                AllowSorting="true"
                AllowFiltering="true" FilterMode="FilterMode.Simple"
                IsLoading="@isLoading" EmptyText="No transactions found.">
    <Columns>
        <RadzenDataGridColumn TItem="TransactionViewDto" Property="TransactionDate" Title="Date" Width="120px">
            <Template Context="data">
                <span style="color: var(--text-secondary);">@data.TransactionDate.ToString("yyyy.MM.dd")</span>
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn TItem="TransactionViewDto" Property="CategoryName" Title="Category" Width="150px" />

        <RadzenDataGridColumn TItem="TransactionViewDto" Property="Description" Title="Description" />

        <RadzenDataGridColumn TItem="TransactionViewDto" Property="Amount" Title="Amount" TextAlign="TextAlign.Right" Width="140px">
            <Template Context="data">
                <RadzenText TextStyle="TextStyle.Body1" Style="@(data.Type == TransactionType.Expense ? "color: #ef4444;" : "color: #22c55e; font-weight:bold;")">
                    @(data.Type == TransactionType.Expense ? "-" : "+") @data.Amount.ToString("C0")
                </RadzenText>
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn TItem="TransactionViewDto" Title="Actions" TextAlign="TextAlign.Center" Width="120px" Sortable="false" Filterable="false">
            <Template Context="data">
                <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.Medium" Click="@(args => OpenTransactionDialog(data))" Class="rz-mr-1" />
                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Flat" Size="ButtonSize.Medium" Click="@(args => DeleteTransaction(data))" />
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    
    private IEnumerable<TransactionViewDto>? transactions;
    private bool isLoading = false;
    private DateTime? startDate = DateTime.Now.AddDays(-30);
    private DateTime? endDate = DateTime.Now;

    protected override async Task OnInitializedAsync()
    {
        await LoadTransactionsAsync();
    }

    private async Task LoadTransactionsAsync()
    {
        isLoading = true;
        try
        {
            var start = startDate?.ToString("yyyy-MM-dd");
            var end = endDate?.ToString("yyyy-MM-dd");
            var url = $"api/transaction?startDate={start}&endDate={end}";
            transactions = await Http.GetFromJsonAsync<List<TransactionViewDto>>(url);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OpenTransactionDialog(TransactionViewDto? transaction)
    {
        var result = await DialogService.OpenAsync<BudgetTrackingApp.Client.Shared.TransactionDialog>(
            transaction == null ? "New Transaction" : "Edit Transaction",
            new Dictionary<string, object> { { "TransactionId", transaction?.Id } },
            new DialogOptions() { Width = "500px", Height = "auto", Draggable = true, Resizable = false, CssClass = "xtract-card" }
        );

        if (result == true)
        {
            await LoadTransactionsAsync();
        }
    }

    private async Task DeleteTransaction(TransactionViewDto transaction)
    {
        var confirm = await DialogService.Confirm("Are you sure you want to delete this item?", "Confirm Delete",
            new ConfirmOptions() { OkButtonText = "Yes", CancelButtonText = "No", CssClass = "xtract-card" });

        if (confirm == true)
        {
            try
            {
                var response = await Http.DeleteAsync($"api/transaction/{transaction.Id}");
                if (response.IsSuccessStatusCode)
                {
                    NotificationService.Notify(NotificationSeverity.Success, "Success", "Transaction deleted!");
                    await LoadTransactionsAsync();
                }
            }
            catch (Exception ex)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
            }
        }
    }
}