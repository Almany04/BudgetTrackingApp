@page "/transactions"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@attribute [Authorize]

@using BudgetTrackingApp.Shared.Dtos.Transactions
@using BudgetTrackingApp.Shared.Enums
@inject HttpClient Http
@inject DialogService DialogService
@inject NotificationService NotificationService

<PageTitle>Tranzakciók</PageTitle>

<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Class="rz-mb-4">
    <RadzenText TextStyle="TextStyle.H5">Tranzakciók</RadzenText>
    <RadzenButton Text="Új Tranzakció" Icon="add" ButtonStyle="ButtonStyle.Primary" Click="@(() => OpenTransactionDialog(null))" />
</RadzenStack>

<RadzenCard Class="rz-mb-4">
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem" Wrap="FlexWrap.Wrap">
        <RadzenDatePicker @bind-Value="startDate" DateFormat="yyyy.MM.dd" Placeholder="Kezdő dátum" />
        <RadzenDatePicker @bind-Value="endDate" DateFormat="yyyy.MM.dd" Placeholder="Végdátum" />
        <RadzenButton Text="Szűrés" Click="LoadTransactionsAsync" Icon="search" />
    </RadzenStack>
</RadzenCard>

<RadzenDataGrid Data="@transactions" TItem="TransactionViewDto" AllowPaging="true" PageSize="10" AllowSorting="true" IsLoading="@isLoading" EmptyText="Nincs megjeleníthető adat.">
    <Columns>
        <RadzenDataGridColumn TItem="TransactionViewDto" Property="TransactionDate" Title="Dátum">
            <Template Context="data">
                @data.TransactionDate.ToString("yyyy.MM.dd")
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="TransactionViewDto" Property="CategoryName" Title="Kategória" />
        <RadzenDataGridColumn TItem="TransactionViewDto" Property="Description" Title="Leírás" />
        <RadzenDataGridColumn TItem="TransactionViewDto" Property="Amount" Title="Összeg" TextAlign="TextAlign.Right">
            <Template Context="data">
                <span style='color: @(data.Type == TransactionType.Expense ? "var(--rz-danger)" : "var(--rz-success)")'>
                    @(data.Type == TransactionType.Expense ? "-" : "+") @data.Amount.ToString("C0")
                </span>
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="TransactionViewDto" Title="Műveletek" TextAlign="TextAlign.Center" Width="100px">
            <Template Context="data">
                <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" Click="@(() => OpenTransactionDialog(data))" Class="rz-mr-1" />
                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Click="@(() => DeleteTransaction(data))" />
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    private IEnumerable<TransactionViewDto>? transactions;
    private bool isLoading = false;
    private DateTime? startDate = DateTime.Now.AddDays(-30);
    private DateTime? endDate = DateTime.Now;

    protected override async Task OnInitializedAsync()
    {
        await LoadTransactionsAsync();
    }

    private async Task LoadTransactionsAsync()
    {
        isLoading = true;
        try
        {
            var start = startDate?.ToString("yyyy-MM-dd");
            var end = endDate?.ToString("yyyy-MM-dd");
            var url = $"api/transaction?startDate={start}&endDate={end}";

            transactions = await Http.GetFromJsonAsync<List<TransactionViewDto>>(url);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Hiba", $"Adatok betöltése sikertelen: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OpenTransactionDialog(TransactionViewDto? transaction)
    {
        var result = await DialogService.OpenAsync<BudgetTrackingApp.Client.Shared.TransactionDialog>(
            transaction == null ? "Új Tranzakció" : "Tranzakció Szerkesztése",
            new Dictionary<string, object> { { "TransactionId", transaction?.Id } },
            new DialogOptions() { Width = "500px", Height = "auto" }
        );

        if (result == true)
        {
            await LoadTransactionsAsync();
        }
    }

    private async Task DeleteTransaction(TransactionViewDto transaction)
    {
        var confirm = await DialogService.Confirm($"Biztosan törölni szeretnéd?", "Törlés", new ConfirmOptions() { OkButtonText = "Igen", CancelButtonText = "Nem" });
        if (confirm == true)
        {
            try
            {
                var response = await Http.DeleteAsync($"api/transaction/{transaction.Id}");
                if (response.IsSuccessStatusCode)
                {
                    NotificationService.Notify(NotificationSeverity.Success, "Siker", "Tranzakció törölve!");
                    await LoadTransactionsAsync();
                }
            }
            catch (Exception ex)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Hiba", ex.Message);
            }
        }
    }
}