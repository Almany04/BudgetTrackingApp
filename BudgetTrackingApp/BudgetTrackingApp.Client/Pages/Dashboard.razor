@page "/dashboard"
@using BudgetTrackingApp.Shared.Dtos.Budget
@using BudgetTrackingApp.Shared.Dtos.Transactions
@using BudgetTrackingApp.Shared.Enums
@inject HttpClient Http
@inject NavigationManager Navigation
@inject DialogService DialogService

<PageTitle>Dashboard</PageTitle>


@if (isCriticalLoading)
{
    <div style="height: 50vh; display: flex; justify-content: center; align-items: center;">
        <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="width: 200px; background: rgba(255,255,255,0.1);" />
    </div>
}
else
{
    <div class="animate-in">
        <RadzenStack Gap="1.5rem">

            @* --- HEADER --- *@
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Wrap="FlexWrap.Wrap" Gap="1rem">
                <div>
                    <h1 style="font-size: 1.8rem; margin: 0; color: white; font-weight: 800;">Dashboard</h1>
                    <span style="color: var(--text-secondary); font-size: 0.9rem;">Financial Overview</span>
                </div>
                <RadzenButton Text="Add Expense" Icon="add_circle" ButtonStyle="ButtonStyle.Primary" Click="@(() => Navigation.NavigateTo("transactions"))" />
            </RadzenStack>

            @* --- ROW 1: DETAILS + AI --- *@
            <RadzenRow Gutter="1.5rem">

                @* 1. CATEGORY DETAILS *@
                <RadzenColumn Size="12" SizeMD="6">
                    <div class="xtract-card" style="padding: 1.5rem; height: 100%; min-height: 400px;">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1.2rem; color: white; font-weight: 700;">What did I buy?</h3>
                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem;">Item breakdown</p>

                        <div style="background: rgba(255,255,255,0.05); padding: 0.8rem; border-radius: 10px; margin-bottom: 1rem;">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                                <span style="color: white; font-weight: 600; white-space: nowrap; font-size: 0.9rem;">Store:</span>
                                <RadzenDropDown @bind-Value="selectedMerchant"
                                                Data="@merchantNames"
                                                Change="@UpdateDetailChart"
                                                Placeholder="Select a store..."
                                                Style="width: 100%;"
                                                class="rz-dropdown-dark" />
                            </RadzenStack>
                        </div>

                        @if (categoryData.Any())
                        {
                            <RadzenChart Style="height: 280px; background: transparent; font-family: 'Inter';">
                                <RadzenDonutSeries Data="@categoryData"
                                                   CategoryProperty="Label"
                                                   ValueProperty="Total"
                                                   Fills="@categoryColors">
                                    @* REMOVED DATA LABELS FOR CLEANER LOOK *@
                                    <TitleTemplate>
                                        <div class="rz-donut-content" style="text-align: center;">
                                            <div style="color: var(--text-secondary); font-size: 0.8rem;">Total</div>
                                            <div style="color: white; font-size: 1.1rem; font-weight: 800;">
                                                @categoryData.Sum(x => x.Total).ToString("N0")
                                            </div>
                                        </div>
                                    </TitleTemplate>
                                    <TooltipTemplate Context="data">
                                        <div style="background: rgba(0,0,0,0.8); padding: 5px; border: 1px solid #10b981; border-radius: 4px;">
                                            <strong style="color: #fff">@data.Label</strong>: <span style="color: #34d399">@data.Total.ToString("N0")</span>
                                        </div>
                                    </TooltipTemplate>
                                </RadzenDonutSeries>
                                <RadzenLegend Visible="true" Position="LegendPosition.Right" />
                            </RadzenChart>
                        }
                        else
                        {
                            <div style="height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--text-secondary); border: 2px dashed rgba(255,255,255,0.1); border-radius: 12px;">
                                <RadzenIcon Icon="filter_list" Style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;" />
                                <span style="font-size: 0.9rem;">@(string.IsNullOrEmpty(selectedMerchant) ? "Select a store above." : "No details found.")</span>
                            </div>
                        }
                    </div>
                </RadzenColumn>

                @* 2. AI ADVISOR (Async Load) *@
                <RadzenColumn Size="12" SizeMD="6">
                    <div class="xtract-card" style="padding: 1.5rem; height: 100%; min-height: 400px; background: linear-gradient(160deg, rgba(124, 58, 237, 0.08), transparent) !important; border: 1px solid rgba(139, 92, 246, 0.2);">
                        <RadzenStack Gap="1rem" Style="height: 100%;">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                <RadzenIcon Icon="auto_awesome" Style="color: #a78bfa;" />
                                <span style="font-weight: 800; letter-spacing: 1px; font-size: 0.9rem; color: #a78bfa;">AI ADVISOR</span>
                            </RadzenStack>

                            <div style="flex-grow: 1; overflow-y: auto; max-height: 320px;">
                                @if (isAiLoading)
                                {
                                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #a78bfa;">
                                        <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="width: 50px; height: 4px; margin-bottom: 10px;" />
                                        <span style="font-size: 0.8rem;">Analyzing your spending...</span>
                                    </div>
                                }
                                else if (aiSuggestions.Any())
                                {
                                    <RadzenStack Gap="0.8rem">
                                        @foreach (var suggestion in aiSuggestions)
                                        {
                                            <div style="font-size: 0.9rem; line-height: 1.5; color: #e5e7eb; border-left: 3px solid #7c3aed; padding-left: 12px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 0 8px 8px 0;">
                                                @suggestion
                                            </div>
                                        }
                                    </RadzenStack>
                                }
                                else
                                {
                                    <div style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: var(--text-secondary); opacity: 0.7;">
                                        <RadzenIcon Icon="psychology" Style="font-size: 3rem; margin-bottom: 1rem;" />
                                        <span style="font-size: 1rem;">Add expenses to unlock AI tips!</span>
                                    </div>
                                }
                            </div>
                        </RadzenStack>
                    </div>
                </RadzenColumn>

            </RadzenRow>

            @* --- ROW 2: MERCHANTS + BUDGET --- *@
            <RadzenRow Gutter="1.5rem">

                @* 3. MERCHANT CHART *@
                <RadzenColumn Size="12" SizeMD="6">
                    <div class="xtract-card" style="padding: 1.5rem; height: 100%; min-height: 350px;">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1.2rem; color: white; font-weight: 700;">Where do I spend?</h3>
                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem;">Top 10 Shops</p>

                        @if (merchantData.Any())
                        {
                            <RadzenChart Style="height: 300px; background: transparent; font-family: 'Inter';">
                                <RadzenBarSeries Data="@merchantData"
                                                 CategoryProperty="Label"
                                                 ValueProperty="Total"
                                                 Fills="@merchantColors">
                                    <TooltipTemplate Context="data">
                                        <div style="background: rgba(0,0,0,0.9); padding: 8px; border: 1px solid #8b5cf6; border-radius: 4px;">
                                            <strong style="color: #fff">@data.Label</strong><br />
                                            <span style="color: #a78bfa">@data.Total.ToString("N0") HUF</span>
                                        </div>
                                    </TooltipTemplate>
                                </RadzenBarSeries>

                                <RadzenValueAxis Visible="false">
                                    <RadzenGridLines Visible="false" />
                                </RadzenValueAxis>

                                <RadzenCategoryAxis>
                                    <RadzenAxisTitle Text="" />
                                    <RadzenGridLines Visible="false" />
                                    <RadzenTicks Visible="false" />
                                </RadzenCategoryAxis>

                                <RadzenLegend Visible="false" />
                            </RadzenChart>
                        }
                        else
                        {
                            <div style="height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--text-secondary); opacity: 0.5;">
                                <RadzenIcon Icon="shopping_cart" Style="font-size: 2.5rem; margin-bottom: 0.5rem;" />
                                <span>No data available.</span>
                            </div>
                        }
                    </div>
                </RadzenColumn>

                @* 4. BUDGET OVERVIEW (EDITABLE & REFRESHING) *@
                <RadzenColumn Size="12" SizeMD="6">
                    <div class="xtract-card" style="padding: 1.5rem; height: 100%; min-height: 350px; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: center;">
                        <div style="position: absolute; right: -40px; top: -40px; width: 180px; height: 180px; background: radial-gradient(circle, rgba(139, 92, 246, 0.15), transparent 70%); pointer-events: none;"></div>

                        <RadzenStack Gap="1.5rem">
                            <div style="text-transform: uppercase; color: var(--text-secondary); font-size: 0.75rem; letter-spacing: 1px; font-weight: 700;">Monthly Spending</div>

                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                                <div style="font-size: 2.8rem; font-weight: 800; color: white; line-height: 1;">
                                    @((budget?.SpentAmount ?? 0).ToString("N0"))
                                </div>
                                <span style="font-size: 1.2rem; color: var(--text-secondary); font-weight: 500; margin-top: 10px;">HUF</span>
                            </RadzenStack>

                            <div>
                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" Class="rz-mb-2">
                                    <div style="background: rgba(139, 92, 246, 0.15); color: #a78bfa; padding: 0.2rem 0.6rem; border-radius: 6px; font-weight: 600; font-size: 0.9rem;">
                                        @budgetPercentage.ToString("0")%
                                    </div>

                                    @* EDIT BUTTON *@
                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                        <span style="color: var(--text-secondary); font-size: 0.9rem;">
                                            Limit: <span style="color: white;">@((budget?.LimitAmount ?? 0).ToString("N0"))</span>
                                        </span>
                                        <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.ExtraSmall" Click="@OpenBudgetDialog" />
                                    </RadzenStack>

                                </RadzenStack>
                                <RadzenProgressBar Value="@budgetPercentage" Max="100" ShowValue="false" Style="height: 12px; background: rgba(255,255,255,0.1); border-radius: 6px;" />
                            </div>
                        </RadzenStack>
                    </div>
                </RadzenColumn>

            </RadzenRow>
        </RadzenStack>
    </div>
}

@code {
    private BudgetViewDto? budget;
    private double budgetPercentage = 0;

    private bool isCriticalLoading = true; 
    private bool isAiLoading = true;       

    private List<string> aiSuggestions = new();
    private List<TransactionViewDto> allTransactions = new();

    private List<ChartItem> merchantData = new();
    private List<string> merchantNames = new();
    private List<ChartItem> categoryData = new();
    private string? selectedMerchant;

    private string[] merchantColors = new[] { "#8b5cf6", "#6366f1", "#a855f7", "#d946ef", "#ec4899", "#f43f5e" };
    private string[] categoryColors = new[] { "#10b981", "#06b6d4", "#3b82f6", "#f59e0b", "#ef4444", "#8b5cf6" };

    class ChartItem { public string Label { get; set; } = ""; public double Total { get; set; } }

    protected override async Task OnInitializedAsync()
    {
        await LoadMainDataAsync();
        
        _ = LoadAiDataAsync();
    }

    private async Task LoadMainDataAsync()
    {
        isCriticalLoading = true;
        try
        {
            var budgetTask = Http.GetFromJsonAsync<BudgetViewDto>("api/budget");
            var startDate = DateTime.Now.AddDays(-30);
            var endDate = DateTime.Now;
            var transactionsTask = Http.GetFromJsonAsync<List<TransactionViewDto>>($"api/transaction?startDate={startDate:yyyy-MM-dd}&endDate={endDate:yyyy-MM-dd}");

            await Task.WhenAll(budgetTask, transactionsTask);

            budget = await budgetTask;
            allTransactions = await transactionsTask ?? new();

            RefreshBudgetCalculations();
            PrepareMerchantChart();
        }
        catch (Exception ex) { Console.WriteLine($"Err: {ex.Message}"); }
        finally { isCriticalLoading = false; }
    }

    // Separate AI Loader so it doesn't block
    private async Task LoadAiDataAsync()
    {
        isAiLoading = true;
        StateHasChanged(); 
        try
        {
            aiSuggestions = await Http.GetFromJsonAsync<List<string>>("api/aisuggestion") ?? new();
        }
        catch { /* Silent fail */ }
        finally
        {
            isAiLoading = false;
            StateHasChanged(); 
        }
    }

    private void RefreshBudgetCalculations()
    {
        if (budget != null && budget.LimitAmount > 0)
            budgetPercentage = Math.Min(100, (double)(budget.SpentAmount / budget.LimitAmount) * 100);
    }

    private void PrepareMerchantChart()
    {
        var expenses = allTransactions.Where(t => t.Type == TransactionType.Expense).ToList();

        merchantData = expenses
            .GroupBy(t => string.IsNullOrWhiteSpace(t.Merchant) ? "Unknown" : t.Merchant)
            .Select(g => new ChartItem { Label = g.Key, Total = (double)g.Sum(t => t.Amount) })
            .OrderByDescending(x => x.Total) // Sort highest first
            .Take(10) // <--- NEW: Limit to top 10 to prevent overcrowding
            .OrderBy(x => x.Total) // Re-sort ascending for Bar Chart (so biggest is at top visually)
            .ToList();

        merchantNames = merchantData.Select(m => m.Label).ToList();

        // Select the biggest spender by default for the detail chart
        if (merchantNames.Any())
        {
            selectedMerchant = merchantNames.Last(); // Last because we re-sorted for the chart
            UpdateDetailChart();
        }
    }
    private void UpdateDetailChart()
    {
        if (string.IsNullOrEmpty(selectedMerchant)) { categoryData = new(); return; }
        var storeExpenses = allTransactions
            .Where(t => t.Type == TransactionType.Expense &&
                       (string.IsNullOrWhiteSpace(t.Merchant) ? "Unknown" : t.Merchant) == selectedMerchant);

        categoryData = storeExpenses
            .GroupBy(t =>
            {
                if (t.CategoryName.Contains(" > ")) return t.CategoryName.Split(" > ")[1];
                return t.CategoryName;
            })
            .Select(g => new ChartItem { Label = g.Key, Total = (double)g.Sum(t => t.Amount) })
            .OrderByDescending(x => x.Total)
            .ToList();
    }

    private async Task OpenBudgetDialog()
    {
        var result = await DialogService.OpenAsync<BudgetTrackingApp.Client.Shared.BudgetDialog>("Edit Limit",
            new Dictionary<string, object> { { "CurrentLimit", budget?.LimitAmount ?? 0 } },
            new DialogOptions() { Width = "400px", CssClass = "xtract-card" }
        );

        // If saved, RELOAD budget specifically
        if (result == true)
        {
            budget = await Http.GetFromJsonAsync<BudgetViewDto>("api/budget");
            RefreshBudgetCalculations();
            StateHasChanged(); // Force UI Refresh
        }
    }
}