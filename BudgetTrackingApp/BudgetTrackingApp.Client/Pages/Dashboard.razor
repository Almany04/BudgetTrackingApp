@page "/dashboard"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@attribute [Authorize]

@using BudgetTrackingApp.Shared.Dtos.Budget
@using BudgetTrackingApp.Shared.Dtos.Transactions
@using BudgetTrackingApp.Shared.Enums
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Dashboard</PageTitle>

@if (isLoading)
{
    <div style="height: 80vh; display: flex; justify-content: center; align-items: center;">
        <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="width: 150px; height: 2px; background: rgba(255,255,255,0.1);" />
    </div>
}
else
{
    <div class="animate-in">
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Class="rz-mb-5">
            <RadzenStack Gap="0">
                <h1 style="font-size: 2rem; font-weight: 800; color: white; margin: 0;">Overview</h1>
                <span style="color: var(--text-secondary);">Welcome back to your financial hub.</span>
            </RadzenStack>
            <RadzenButton Text="Add Expense" Icon="add" Class="rz-button-primary" Click="@(() => Navigation.NavigateTo("transactions"))" />
        </RadzenStack>

        <RadzenRow Gutter="1.5rem">

            <RadzenColumn Size="12" SizeLG="8">
                <RadzenCard Class="xtract-card" Style="padding: 2.5rem; height: 100%;">
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Start">
                        <div>
                            <div style="color: var(--text-secondary); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem;">Monthly Spending</div>
                            <div style="font-size: 3.5rem; font-weight: 800; color: white; line-height: 1;">
                                @((budget?.SpentAmount ?? 0).ToString("N0"))
                            </div>
                            <div style="color: var(--text-secondary); margin-top: 5px;">
                                / @((budget?.LimitAmount ?? 0).ToString("N0")) HUF Limit
                            </div>
                        </div>

                        <div style="background: rgba(124, 58, 237, 0.1); color: #a78bfa; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 700; border: 1px solid rgba(124, 58, 237, 0.2);">
                            @budgetPercentage.ToString("0")% Used
                        </div>
                    </RadzenStack>

                    <div style="margin-top: 2rem;">
                        <RadzenProgressBar Value="@budgetPercentage" Max="100" ShowValue="false" Style="height: 6px; background: rgba(255,255,255,0.1);" />
                    </div>
                </RadzenCard>
            </RadzenColumn>

            <RadzenColumn Size="12" SizeLG="4">
                <RadzenCard Class="xtract-card" Style="padding: 1.5rem; height: 100%; background: linear-gradient(160deg, rgba(124, 58, 237, 0.05), transparent) !important;">
                    <RadzenStack Gap="1rem">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                            <RadzenIcon Icon="auto_awesome" Style="color: #a78bfa;" />
                            <span style="font-weight: 700; color: white; font-size: 0.9rem; letter-spacing: 1px;">AI INSIGHTS</span>
                        </RadzenStack>

                        @if (aiSuggestions.Any())
                        {
                            <RadzenStack Gap="1rem">
                                @foreach (var suggestion in aiSuggestions.Take(3))
                                {
                                    <div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5; border-left: 2px solid #a78bfa; padding-left: 10px;">
                                        @suggestion
                                    </div>
                                }
                            </RadzenStack>
                        }
                        else
                        {
                            <span style="color: var(--text-muted);">No insights available yet.</span>
                        }
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

            <RadzenColumn Size="12">
                <RadzenCard Class="xtract-card" Style="padding: 2rem;">
                    <RadzenText TextStyle="TextStyle.H6" Class="rz-mb-4" Style="color: white;">Top Categories</RadzenText>
                    @if (chartData.Any())
                    {
                        <RadzenChart Style="height: 250px; background: transparent;">
                            <RadzenColumnSeries Data="@chartData" CategoryProperty="Category" ValueProperty="Total" Fill="#8b5cf6" Stroke="none" />
                            <RadzenCategoryAxis Padding="20" Visible="true" />
                            <RadzenValueAxis Formatter="@(value => ((double)value).ToString("N0"))">
                                <RadzenGridLines Visible="true" Stroke="rgba(255,255,255,0.05)" />
                            </RadzenValueAxis>
                            <RadzenLegend Visible="false" />
                        </RadzenChart>
                    }
                    else
                    {
                        <div style="height: 200px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
                            No data to display.
                        </div>
                    }
                </RadzenCard>
            </RadzenColumn>

        </RadzenRow>
    </div>
}

@code {
    private BudgetViewDto? budget;
    private double budgetPercentage = 0;
    private bool isLoading = true;
    private List<string> aiSuggestions = new();
    private List<ChartItem> chartData = new();

    class ChartItem { public string Category { get; set; } = ""; public double Total { get; set; } }

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        try
        {
            var budgetTask = Http.GetFromJsonAsync<BudgetViewDto>("api/budget");
            var endDate = DateTime.Now;
            var startDate = endDate.AddDays(-30);
            var transactionsTask = Http.GetFromJsonAsync<List<TransactionViewDto>>($"api/transaction?startDate={startDate:yyyy-MM-dd}&endDate={endDate:yyyy-MM-dd}");
            var aiTask = Http.GetFromJsonAsync<List<string>>("api/aisuggestion");

            await Task.WhenAll(budgetTask, transactionsTask, aiTask);

            budget = await budgetTask;
            var transactions = await transactionsTask;
            aiSuggestions = await aiTask ?? new();

            if (budget != null && budget.LimitAmount > 0)
            {
                budgetPercentage = Math.Min(100, (double)(budget.SpentAmount / budget.LimitAmount) * 100);
            }

            if (transactions != null)
            {
                chartData = transactions
                   .Where(t => t.Type == TransactionType.Expense)
                   .GroupBy(t => t.CategoryName)
                   .Select(g => new ChartItem { Category = g.Key ?? "Other", Total = (double)g.Sum(t => t.Amount) })
                   .OrderByDescending(x => x.Total)
                   .Take(5)
                   .ToList();
            }
        }
        catch { }
        finally { isLoading = false; }
    }
}