@page "/dashboard"
@using BudgetTrackingApp.Shared.Dtos.Budget
@using BudgetTrackingApp.Shared.Dtos.Transactions
@using BudgetTrackingApp.Shared.Dtos.AI
@using BudgetTrackingApp.Shared.Enums
@inject HttpClient Http
@inject NavigationManager Navigation
@inject DialogService DialogService
@inject NotificationService NotificationService

<PageTitle>Dashboard</PageTitle>

@if (isCriticalLoading)
{
    <div style="height: 50vh; display: flex; justify-content: center; align-items: center;">
        <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="width: 200px; background: rgba(255,255,255,0.1);" />
    </div>
}
else
{
    <div class="animate-in">
        <RadzenStack Gap="1.5rem">

            @* --- HEADER --- *@
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Wrap="FlexWrap.Wrap" Gap="1rem">
                <div>
                    <h1 style="font-size: 1.8rem; margin: 0; color: white; font-weight: 800;">Dashboard</h1>
                    <span style="color: var(--text-secondary); font-size: 0.9rem;">Financial Overview</span>
                </div>
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                    <RadzenButton Text="Scan Receipt" Icon="qr_code_scanner" ButtonStyle="ButtonStyle.Secondary" Click="@OpenScannerDialog" />
                    <RadzenButton Text="Add Expense" Icon="add_circle" ButtonStyle="ButtonStyle.Primary" Click="@(() => Navigation.NavigateTo("transactions"))" />
                </RadzenStack>
            </RadzenStack>

            @* --- ROW 1: AI & CATEGORIES --- *@
            <RadzenRow Gutter="1.5rem">

                @* 1. AI ADVISOR *@
                <RadzenColumn Size="12" SizeMD="6">
                    <div class="xtract-card" style="padding: 1.5rem; height: 100%; min-height: 300px; background: linear-gradient(160deg, rgba(124, 58, 237, 0.15), transparent) !important; border: 1px solid rgba(139, 92, 246, 0.3); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                        <div style="width: 70px; height: 70px; background: rgba(139, 92, 246, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem; box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);">
                            <RadzenIcon Icon="psychology" Style="font-size: 2.5rem; color: #a78bfa;" />
                        </div>
                        <h3 style="color: white; margin-bottom: 0.5rem;">AI Financial Consultant</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem; max-width: 90%;">Get a deep analysis of your spending habits and personalized saving tips.</p>
                        <RadzenButton Text="Open Analysis" Icon="auto_awesome"
                                      ButtonStyle="ButtonStyle.Primary"
                                      Click="@OpenAiWindow"
                                      IsBusy="@isAiLoading" BusyText="Analyzing..." />
                    </div>
                </RadzenColumn>

                @* 2. MERCHANT CHART (Where do I spend?) *@
                <RadzenColumn Size="12" SizeMD="6">
                    <div class="xtract-card" style="padding: 1.5rem; height: 100%; min-height: 300px;">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1.2rem; color: white; font-weight: 700;">Where do I spend?</h3>
                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem;">Top Shops</p>

                        @if (merchantData.Any())
                        {
                            <RadzenChart Style="height: 250px; background: transparent;">
                                <RadzenBarSeries Data="@merchantData" CategoryProperty="Label" ValueProperty="Total" Fills="@merchantColors">
                                    <TooltipTemplate Context="data">
                                        <div style="background: rgba(0,0,0,0.9); padding: 8px; border: 1px solid #8b5cf6; border-radius: 4px;">
                                            <strong style="color: #fff">@data.Label</strong><br />
                                            <span style="color: #a78bfa">@data.Total.ToString("N0") HUF</span>
                                        </div>
                                    </TooltipTemplate>
                                </RadzenBarSeries>
                                <RadzenValueAxis Visible="false" />
                                <RadzenCategoryAxis>
                                    <RadzenGridLines Visible="false" />
                                    <RadzenTicks Visible="false" />
                                </RadzenCategoryAxis>
                                <RadzenLegend Visible="false" />
                            </RadzenChart>
                        }
                        else
                        {
                            <div style="height: 200px; display: flex; justify-content: center; align-items: center; color: var(--text-secondary);">No data available.</div>
                        }
                    </div>
                </RadzenColumn>

            </RadzenRow>

            @* --- ROW 2: BUDGET STATUS --- *@
            <RadzenColumn Size="12">
                <div class="xtract-card" style="padding: 1.5rem; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: center;">
                    <div style="position: absolute; right: -40px; top: -40px; width: 180px; height: 180px; background: radial-gradient(circle, rgba(139, 92, 246, 0.15), transparent 70%); pointer-events: none;"></div>

                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <div style="text-transform: uppercase; color: var(--text-secondary); font-size: 0.75rem; letter-spacing: 1px; font-weight: 700;">Monthly Budget</div>
                        <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.ExtraSmall" Click="@OpenBudgetDialog" Text="Edit Limit" />
                    </RadzenStack>

                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.End" Gap="1rem" Class="rz-mt-2">
                        <div style="font-size: 3rem; font-weight: 800; color: white; line-height: 1;">
                            @((budget?.SpentAmount ?? 0).ToString("N0"))
                        </div>
                        <span style="font-size: 1.2rem; color: var(--text-secondary); font-weight: 500; margin-bottom: 8px;">
                            / @((budget?.LimitAmount ?? 0).ToString("N0")) HUF
                        </span>
                    </RadzenStack>

                    <div class="rz-mt-3">
                        <div style="display:flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="color: #a78bfa; font-size: 0.9rem;">@budgetPercentage.ToString("0")% Used</span>
                        </div>
                        <RadzenProgressBar Value="@budgetPercentage" Max="100" ShowValue="false" Style="height: 12px; background: rgba(255,255,255,0.1); border-radius: 6px;" />
                    </div>
                </div>
            </RadzenColumn>
        </RadzenStack>
    </div>
}

@code {
    private BudgetViewDto? budget;
    private double budgetPercentage = 0;
    private bool isCriticalLoading = true;
    private bool isAiLoading = false;
    private AiAdviceDto? aiAdvice = null;
    private List<TransactionViewDto> allTransactions = new();
    private List<ChartItem> merchantData = new();

    private string[] merchantColors = new[] { "#8b5cf6", "#6366f1", "#a855f7", "#d946ef", "#ec4899", "#f43f5e", "#10b981", "#06b6d4", "#3b82f6", "#f59e0b" };
    class ChartItem { public string Label { get; set; } = ""; public double Total { get; set; } }

    protected override async Task OnInitializedAsync() => await LoadMainDataAsync();

    private async Task LoadMainDataAsync()
    {
        isCriticalLoading = true;
        try
        {
            var budgetTask = Http.GetFromJsonAsync<BudgetViewDto>("api/budget");
            var startDate = DateTime.Now.AddDays(-30);
            var endDate = DateTime.Now;
            var transactionsTask = Http.GetFromJsonAsync<List<TransactionViewDto>>($"api/transaction?startDate={startDate:yyyy-MM-dd}&endDate={endDate:yyyy-MM-dd}");

            await Task.WhenAll(budgetTask, transactionsTask);

            budget = await budgetTask;
            allTransactions = await transactionsTask ?? new();

            RefreshBudgetCalculations();
            PrepareMerchantChart();
        }
        catch (Exception ex) { Console.WriteLine($"Err: {ex.Message}"); }
        finally { isCriticalLoading = false; }
    }

    private async Task OpenAiWindow()
    {
        isAiLoading = true;
        try
        {
            if (aiAdvice == null) aiAdvice = await Http.GetFromJsonAsync<AiAdviceDto>("api/aisuggestion");
            await DialogService.OpenAsync<BudgetTrackingApp.Client.Shared.AiAdviceDialog>("Financial Analysis",
                new Dictionary<string, object> { { "Advice", aiAdvice } },
                new DialogOptions() { Width = "800px", Height = "600px", CssClass = "xtract-card", Resizable = true, Draggable = true }
            );
        }
        catch (Exception) { NotificationService.Notify(NotificationSeverity.Error, "AI Error", "Service unavailable."); }
        finally { isAiLoading = false; }
    }

    private async Task OpenScannerDialog()
    {
        var result = await DialogService.OpenAsync<BudgetTrackingApp.Client.Shared.ReceiptScannerDialog>("Receipt Scanner", null,
             new DialogOptions() { Width = "700px", Height = "auto", CssClass = "xtract-card" });
        if (result == true) await LoadMainDataAsync();
    }

    private void RefreshBudgetCalculations()
    {
        if (budget != null && budget.LimitAmount > 0)
            budgetPercentage = Math.Min(100, (double)(budget.SpentAmount / budget.LimitAmount) * 100);
    }

    private void PrepareMerchantChart()
    {
        var expenses = allTransactions.Where(t => t.Type == TransactionType.Expense).ToList();
        merchantData = expenses
            .GroupBy(t => string.IsNullOrWhiteSpace(t.Merchant) ? "Unknown" : t.Merchant)
            .Select(g => new ChartItem { Label = g.Key, Total = (double)g.Sum(t => t.Amount) })
            .OrderByDescending(x => x.Total)
            .Take(10) // Show top 10
            .ToList();
    }

    private async Task OpenBudgetDialog()
    {
        var result = await DialogService.OpenAsync<BudgetTrackingApp.Client.Shared.BudgetDialog>("Edit Limit",
            new Dictionary<string, object> { { "CurrentLimit", budget?.LimitAmount ?? 0 } },
            new DialogOptions() { Width = "400px", CssClass = "xtract-card" });
        if (result == true) await LoadMainDataAsync();
    }
}