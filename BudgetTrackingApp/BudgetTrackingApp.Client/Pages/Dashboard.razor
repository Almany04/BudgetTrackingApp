@page "/dashboard"
@attribute [Authorize]
@inject HttpClient Http
@inject NotificationService NotificationService

<PageTitle>Vezérlőpult</PageTitle>

<RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1" Class="rz-mb-4">Áttekintés</RadzenText>

@if (isLoading)
{
    <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
}
else
{
    <RadzenRow Class="rz-mb-4">
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenCard Variant="Variant.Outlined">
                <RadzenStack Orientation="Orientation.Vertical" Gap="1rem">
                    <RadzenText TextStyle="TextStyle.H6" Class="rz-mb-0">Havi Budget Állapot</RadzenText>

                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.DisplayH4" Class="rz-color-primary rz-mb-0">
                            @((budget?.SpentAmount ?? 0).ToString("C0"))
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption" Style="padding-top: 10px;">
                            / @((budget?.LimitAmount ?? 0).ToString("C0"))
                        </RadzenText>
                    </RadzenStack>

                    <RadzenProgressBar Value="@budgetPercentage" Max="100" ShowValue="true" Style="@GetProgressStyle()" />

                    <RadzenText TextStyle="TextStyle.Body2" Class="rz-color-secondary">
                        @(budgetPercentage > 100 ? "Túllépted a keretet!" : "Még van kereted.")
                    </RadzenText>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>

        <RadzenColumn Size="12" SizeMD="6">
            <RadzenCard Variant="Variant.Outlined">
                <RadzenText TextStyle="TextStyle.H6" Class="rz-mb-4">Kiadások kategóriánként (elmúlt 30 nap)</RadzenText>
                @if (chartData.Any())
                {
                    <RadzenChart style="height: 250px">
                        <RadzenDonutSeries Data="@chartData" CategoryProperty="Category" ValueProperty="Total">
                            <TitleTemplate>
                                <div class="rz-donut-content">
                                    <div>Kiadások</div>
                                </div>
                            </TitleTemplate>
                            <TooltipTemplate Context="data">
                                <div>
                                    <strong>@data.Category</strong>
                                    <div>@data.Total.ToString("C0")</div>
                                </div>
                            </TooltipTemplate>
                        </RadzenDonutSeries>
                        <RadzenLegend Position="LegendPosition.Right" />
                    </RadzenChart>
                }
                else
                {
                    <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter">
                        Nincs adat az elmúlt 30 napból.
                    </RadzenAlert>
                }
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>
}

@code {
    private BudgetViewDto? budget;
    private double budgetPercentage = 0;
    private bool isLoading = true;

    class ChartItem
    {
        public string Category { get; set; } = "";
        public double Total { get; set; }
    }
    private List<ChartItem> chartData = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        try
        {
            // Budget és tranzakciók párhuzamos betöltése
            var budgetTask = Http.GetFromJsonAsync<BudgetViewDto>("api/budget");

            var endDate = DateTime.Now;
            var startDate = endDate.AddDays(-30);
            var transactionsTask = Http.GetFromJsonAsync<List<TransactionViewDto>>($"api/transaction?startDate={startDate:yyyy-MM-dd}&endDate={endDate:yyyy-MM-dd}");

            await Task.WhenAll(budgetTask, transactionsTask);

            budget = await budgetTask;
            var transactions = await transactionsTask;

            if (budget != null && budget.LimitAmount > 0)
            {
                budgetPercentage = Math.Min(100, (double)(budget.SpentAmount / budget.LimitAmount) * 100);
            }
            else
            {
                budgetPercentage = 0;
            }

            if (transactions != null)
            {
                chartData = transactions
                   .Where(t => t.Type == TransactionType.Expense)
                   .GroupBy(t => t.CategoryName)
                   .Select(g => new ChartItem { Category = g.Key, Total = (double)g.Sum(t => t.Amount) })
                   .ToList();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Hiba", $"Adatok betöltése sikertelen: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetProgressStyle()
    {
        if (budgetPercentage >= 100) return "color: var(--rz-danger); height: 20px;";
        if (budgetPercentage > 75) return "color: var(--rz-warning); height: 20px;";
        return "color: var(--rz-success); height: 20px;";
    }
}