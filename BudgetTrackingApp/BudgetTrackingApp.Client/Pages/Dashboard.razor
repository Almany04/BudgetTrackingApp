@page "/dashboard"
@using BudgetTrackingApp.Shared.Dtos.Budget
@using BudgetTrackingApp.Shared.Dtos.Transactions
@using BudgetTrackingApp.Shared.Dtos.AI
@using BudgetTrackingApp.Shared.Dtos.User
@using BudgetTrackingApp.Shared.Enums
@using BudgetTrackingApp.Client.Shared
@using BudgetTrackingApp.Shared.Dtos.Category
@inject HttpClient Http
@inject NavigationManager Navigation
@inject DialogService DialogService
@inject NotificationService NotificationService

<PageTitle>Dashboard</PageTitle>

<style>
    @@media (max-width: 768px) {
        .chart-container {
            height: 280px !important;
        }

        .chart-legend {
            display: none !important;
        }
    }

    @@media (min-width: 769px) {
        .chart-container {
            height: 350px !important;
        }
    }
</style>

@if (isCriticalLoading)
{
    <div style="height: 50vh; display: flex; justify-content: center; align-items: center;">
        <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="width: 200px; background: rgba(255,255,255,0.1);" />
    </div>
}
else
{
    <div class="animate-in">
        <RadzenStack Gap="1.5rem">

            @* --- HEADER --- *@
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Wrap="FlexWrap.Wrap" Gap="1rem">
                <div>
                    <h1 style="font-size: 1.8rem; margin: 0; color: white; font-weight: 800;">Dashboard</h1>
                    <span style="color: var(--text-secondary); font-size: 0.9rem;">Overview: Last 30 Days</span>
                </div>

                @* Actions *@
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                    @* RESTORED: Receipt Scanner Button *@
                    <RadzenButton Icon="qr_code_scanner" ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Outlined" Click="@OpenScanDialog" ToolTip="Scan Receipt" Size="ButtonSize.Medium" />

                    <RadzenButton Icon="psychology" ButtonStyle="ButtonStyle.Info" Variant="Variant.Outlined" Click="@OpenAiWindow" ToolTip="AI Advice" Size="ButtonSize.Medium" />
                    <RadzenButton Text="Income" Icon="payments" ButtonStyle="ButtonStyle.Success" Click="@OpenAddIncomeDialog" />
                    <RadzenButton Text="Saving" Icon="savings" ButtonStyle="ButtonStyle.Warning" Click="@OpenAddSavingDialog" />
                    <RadzenButton Text="Expense" Icon="add_circle" ButtonStyle="ButtonStyle.Primary" Click="@(() => Navigation.NavigateTo("transactions"))" />
                </RadzenStack>
            </RadzenStack>

            @* --- CHARTS --- *@
            <RadzenRow Gutter="1.5rem">
                @* 1. TOP SHOPS *@
                <RadzenColumn Size="12" SizeMD="6">
                    <div class="xtract-card" style="padding: 1.5rem; height: 100%;">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1.2rem; color: white; font-weight: 700;">Top Shops</h3>
                        @if (merchantData.Any())
                        {
                            <RadzenChart Class="chart-container" Style="background: transparent;">
                                <RadzenBarSeries Data="@merchantData" CategoryProperty="Label" ValueProperty="Total" Fills="@merchantColors">
                                    <TooltipTemplate Context="data">
                                        <div style="background: rgba(0,0,0,0.9); padding: 8px; border: 1px solid #8b5cf6; border-radius: 4px;">
                                            <strong style="color: #fff">@data.Label</strong><br />
                                            <span style="color: #a78bfa">@data.Total.ToString("N0") HUF</span>
                                        </div>
                                    </TooltipTemplate>
                                </RadzenBarSeries>
                                <RadzenValueAxis Visible="false" />
                                <RadzenLegend Visible="false" />
                                <RadzenCategoryAxis Padding="20" />
                            </RadzenChart>
                        }
                        else
                        {
                            <div style="height: 200px; display: flex; justify-content: center; align-items: center; color: var(--text-secondary);">No data available.</div>
                        }
                    </div>
                </RadzenColumn>

                @* 2. WHAT DID I BUY *@
                <RadzenColumn Size="12" SizeMD="6">
                    <div class="xtract-card" style="padding: 1.5rem; height: 100%;">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1.2rem; color: white; font-weight: 700;">What did I buy?</h3>
                        <div style="background: rgba(255,255,255,0.05); padding: 0.8rem; border-radius: 10px; margin-bottom: 1rem;">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                                <span style="color: white; font-weight: 600; white-space: nowrap; font-size: 0.9rem;">Store:</span>
                                <RadzenDropDown @bind-Value="selectedMerchant" Data="@merchantNames" Change="@UpdateDetailChart" Placeholder="Select..." Style="width: 100%;" />
                            </RadzenStack>
                        </div>

                        @if (categoryData.Any())
                        {
                            <RadzenChart Class="chart-container" Style="background: transparent;">
                                <RadzenDonutSeries Data="@categoryData" CategoryProperty="Label" ValueProperty="Total"
                                                   Fills="@categoryColors" Title="Spending" InnerRadius="70">
                                    <TitleTemplate>
                                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%;">
                                            <div style="color: var(--text-secondary); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px;">Total</div>
                                            <div style="color: white; font-size: 1.3rem; font-weight: 800; margin-top: 2px;">@categoryData.Sum(x => x.Total).ToString("N0")</div>
                                        </div>
                                    </TitleTemplate>
                                </RadzenDonutSeries>
                                <RadzenLegend Position="LegendPosition.Right" Class="chart-legend" />
                            </RadzenChart>
                        }
                        else
                        {
                            <div style="height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--text-secondary); border: 2px dashed rgba(255,255,255,0.1); border-radius: 12px;">
                                <span style="font-size: 0.9rem;">@(string.IsNullOrEmpty(selectedMerchant) ? "Select a store above." : "No details found.")</span>
                            </div>
                        }
                    </div>
                </RadzenColumn>
            </RadzenRow>
        </RadzenStack>
    </div>
}

@code {
    private bool isCriticalLoading = true;
    private bool isAiLoading = false;
    private AiAdviceDto? aiAdvice = null;
    private List<TransactionViewDto> allTransactions = new();

    private List<ChartItem> merchantData = new();
    private List<string> merchantNames = new();
    private List<ChartItem> categoryData = new();
    private string? selectedMerchant;
    private string[] merchantColors = new[] { "#8b5cf6", "#6366f1", "#a855f7", "#d946ef", "#ec4899", "#f43f5e", "#10b981", "#06b6d4", "#3b82f6", "#f59e0b" };
    private string[] categoryColors = new[] { "#10b981", "#06b6d4", "#3b82f6", "#f59e0b", "#ef4444", "#8b5cf6" };

    class ChartItem { public string Label { get; set; } = ""; public double Total { get; set; } }

    protected override async Task OnInitializedAsync() => await LoadMainDataAsync();

    private async Task LoadMainDataAsync()
    {
        isCriticalLoading = true;
        try
        {
            var startDate = DateTime.Now.AddDays(-30);
            var endDate = DateTime.Now;
            allTransactions = await Http.GetFromJsonAsync<List<TransactionViewDto>>($"api/transaction?startDate={startDate:yyyy-MM-dd}&endDate={endDate:yyyy-MM-dd}") ?? new();
            PrepareCharts();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Err: {ex.Message}");
        }
        finally
        {
            isCriticalLoading = false;
        }
    }

    private void PrepareCharts()
    {
        var expenses = allTransactions.Where(t => t.Type == TransactionType.Expense).ToList();
        merchantData = expenses.GroupBy(t => string.IsNullOrWhiteSpace(t.Merchant) ? "Unknown" : t.Merchant)
            .Select(g => new ChartItem { Label = g.Key, Total = (double)g.Sum(t => t.Amount) }).OrderByDescending(x => x.Total).Take(10).ToList();

        merchantNames = merchantData.Select(m => m.Label).ToList();
        if (merchantNames.Any())
        {
            selectedMerchant = merchantNames.First(); UpdateDetailChart();
        }
    }

    private void UpdateDetailChart()
    {
        if (string.IsNullOrEmpty(selectedMerchant))
        {
            categoryData = new();
            return;
        }
        var storeExpenses = allTransactions.Where(t => t.Type == TransactionType.Expense && (string.IsNullOrWhiteSpace(t.Merchant) ? "Unknown" : t.Merchant) == selectedMerchant);
        categoryData = storeExpenses.GroupBy(t => t.CategoryName.Contains(">") ? t.CategoryName.Split('>')[1].Trim() : t.CategoryName)
            .Select(g => new ChartItem { Label = g.Key, Total = (double)g.Sum(t => t.Amount) }).OrderByDescending(x => x.Total).ToList();
    }

    private async Task OpenAiWindow()
    {
        isAiLoading = true;
        try
        {
            if (aiAdvice == null) aiAdvice = await Http.GetFromJsonAsync<AiAdviceDto>("api/aisuggestion");
            await DialogService.OpenAsync<AiAdviceDialog>("Financial Analysis", new Dictionary<string, object> { { "Advice", aiAdvice } }, new DialogOptions() { Width = "800px", Height = "600px", CssClass = "xtract-card" });
        }
        catch (Exception)
        {
            NotificationService.Notify(NotificationSeverity.Error, "AI Error", "Service unavailable.");
        }
        finally
        {
            isAiLoading = false;
        }
    }

    // --- RESTORED: Scan Receipt Dialog ---
    private async Task OpenScanDialog()
    {
        var result = await DialogService.OpenAsync<ReceiptScannerDialog>("AI Receipt Scanner", null,
            new DialogOptions() { Width = "700px", CssClass = "xtract-card" });

        if (result == true) await LoadMainDataAsync();
    }

    // --- Add Income Button Logic (Fixed) ---
    private async Task OpenAddIncomeDialog()
    {
        var result = await DialogService.OpenAsync<TransactionDialog>("Add Income",
            new Dictionary<string, object> { { "ForcedType", TransactionType.Income } },
            new DialogOptions() { Width = "500px", CssClass = "xtract-card" });

        if (result == true) await LoadMainDataAsync();
    }

    // --- Add Saving to Goal (Smart Dialog) ---
    private async Task OpenAddSavingDialog()
    {
        var goals = await Http.GetFromJsonAsync<List<SavingGoalDto>>("api/features/goals");
        var goalsList = goals?.ToList() ?? new List<SavingGoalDto>();

        if (!goalsList.Any(g => g.Name == "General Savings"))
        {
            goalsList.Insert(0, new SavingGoalDto { Id = Guid.Empty, Name = "General Savings", CurrentAmount = 0 });
        }

        var selectedGoal = goalsList.FirstOrDefault(g => g.Name == "General Savings") ?? goalsList.First();
        decimal amountToAdd = 0;

        var result = await DialogService.OpenAsync("Add to Savings", ds =>
    @<RadzenStack Gap="1rem" Style="padding: 1rem;">
    <RadzenText TextStyle="TextStyle.Body1">Select a goal to fund:</RadzenText>

    <RadzenDropDown Data="@goalsList" @bind-Value="selectedGoal" TextProperty="Name" Style="width: 100%" />

    <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--text-secondary);">
        Current Balance: @selectedGoal.CurrentAmount.ToString("N0")
    </RadzenText>

    <RadzenFormField Text="Amount to Add" Variant="Variant.Outlined">
        <RadzenNumeric @bind-Value="amountToAdd" Format="c0" Style="width: 100%" />
    </RadzenFormField>

    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem" Class="rz-mt-2">
        <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="() => ds.Close(false)" />
        <RadzenButton Text="Confirm Saving" ButtonStyle="ButtonStyle.Success" Click="() => ds.Close(true)" />
    </RadzenStack>
</RadzenStack>
        , new DialogOptions() { Width = "400px", CssClass = "xtract-card" });

        if (result == true && amountToAdd > 0)
        {
            if (selectedGoal.Id == Guid.Empty && selectedGoal.Name == "General Savings")
            {
                var newGoal = new SavingGoalDto { Name = "General Savings", TargetAmount = 1000000, CurrentAmount = amountToAdd };
                await Http.PostAsJsonAsync("api/features/goals", newGoal);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Started General Savings!");
            }
            else
            {
                var updateDto = new SavingGoalUpdateDto
                {
                    Name = selectedGoal.Name,
                    TargetAmount = selectedGoal.TargetAmount,
                    CurrentAmount = selectedGoal.CurrentAmount + amountToAdd
                };
                await Http.PutAsJsonAsync($"api/features/goals/{selectedGoal.Id}", updateDto);
                NotificationService.Notify(NotificationSeverity.Success, "Saved", $"{amountToAdd:N0} added to {selectedGoal.Name}");
            }
        }
    }
}