@page "/dashboard"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@attribute [Authorize]

@using BudgetTrackingApp.Shared.Dtos.Budget
@using BudgetTrackingApp.Shared.Dtos.Transactions
@using BudgetTrackingApp.Shared.Enums
@inject HttpClient Http
@inject NotificationService NotificationService

<PageTitle>Vezérlőpult</PageTitle>

<RadzenGrid Count="2" Class="rz-p-0 rz-p-md-4">
    <RadzenRow Gap="1rem">
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenCard>
                <RadzenText TextStyle="TextStyle.H6">Havi Keret</RadzenText>
                @if (budget != null)
                {
                    <RadzenText TextStyle="TextStyle.DisplayH4" Class="rz-color-primary">@budget.SpentAmount.ToString("C0")</RadzenText>
                    <RadzenText TextStyle="TextStyle.Caption">Limit: @budget.LimitAmount.ToString("C0")</RadzenText>
                    <RadzenProgressBar Value="@budgetPercentage" Max="100" ShowValue="true" Class="rz-mt-4" Style="@GetProgressStyle()" />
                }
                else
                {
                    <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                }
            </RadzenCard>
        </RadzenColumn>

        <RadzenColumn Size="12" SizeMD="6">
             <RadzenCard>
                <RadzenText TextStyle="TextStyle.H6">Kiadások megoszlása</RadzenText>
                @if (chartData.Any())
                {
                    <RadzenChart>
                        <RadzenDonutSeries Data="@chartData" CategoryProperty="Category" ValueProperty="Total">
                            <TitleTemplate>
                                <div class="rz-donut-content">
                                    <div>Kiadások</div>
                                </div>
                            </TitleTemplate>
                        </RadzenDonutSeries>
                        <RadzenLegend Position="LegendPosition.Right" />
                    </RadzenChart>
                }
                else
                {
                     <RadzenText>Nincs adat.</RadzenText>
                }
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>
</RadzenGrid>

@code {
    private BudgetViewDto? budget;
    private double budgetPercentage = 0;
    
   
    class ChartItem { public string Category { get; set; } public double Total { get; set; } }
    private List<ChartItem> chartData = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try {
             budget = await Http.GetFromJsonAsync<BudgetViewDto>("api/budget");
             if (budget != null && budget.LimitAmount > 0)
             {
                budgetPercentage = (double)(budget.SpentAmount / budget.LimitAmount) * 100;
             }

             // Chart adatok betöltése (egyszerűsítve a meglévő logika alapján)
             var endDate = DateTime.Now;
             var startDate = endDate.AddDays(-30);
             var transactions = await Http.GetFromJsonAsync<List<TransactionViewDto>>($"api/transaction?startDate={startDate:yyyy-MM-dd}&endDate={endDate:yyyy-MM-dd}");
             
             if(transactions != null) {
                 chartData = transactions
                    .Where(t => t.Type == TransactionType.Expense)
                    .GroupBy(t => t.CategoryName)
                    .Select(g => new ChartItem { Category = g.Key, Total = (double)g.Sum(t => t.Amount) })
                    .ToList();
             }
        }
        catch(Exception ex) {
             NotificationService.Notify(NotificationSeverity.Error, "Hiba", ex.Message);
        }
    }

    private string GetProgressStyle()
    {
        if (budgetPercentage > 90) return "color: var(--rz-danger)";
        if (budgetPercentage > 75) return "color: var(--rz-warning)";
        return "";
    }
}