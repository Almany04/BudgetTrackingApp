@page "/register"
@layout BudgetTrackingApp.Client.Shared.AuthLayout
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@using BudgetTrackingApp.Shared.Dtos.User
@inject HttpClient Http
@inject NavigationManager Navigation
@inject NotificationService NotificationService

<PageTitle>Register - UniBudget</PageTitle>

<div class="animate-in" style="width: 100%; max-width: 420px;">

    <div style="text-align: center; margin-bottom: 2rem;">
        <RadzenText TextStyle="TextStyle.H3" Style="color: white; font-weight: 800; margin: 0; letter-spacing: -1px;">Join UniBudget</RadzenText>
        <RadzenText TextStyle="TextStyle.Body1" Style="color: var(--text-secondary); margin-top: 0.5rem;">Start tracking your finances today.</RadzenText>
    </div>

    <RadzenCard Class="xtract-card" Style="padding: 2.5rem;">
        <RadzenTemplateForm TItem="UserRegisterDto" Data="@registerModel" Submit="@HandleRegistration">
            <RadzenStack Spacing="1.5rem">

                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Subtitle2" Style="color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 700;">Email</RadzenText>
                    <RadzenTextBox @bind-Value="registerModel.Email" Name="Email" Style="width: 100%;" Placeholder="you@example.com" />
                    <RadzenRequiredValidator Component="Email" Text="Email is required" />
                    <RadzenEmailValidator Component="Email" Text="Invalid email address" />
                </RadzenStack>

                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Subtitle2" Style="color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 700;">Password</RadzenText>
                    <RadzenPassword @bind-Value="registerModel.Password" Name="Password" Style="width: 100%;" />
                    <RadzenRequiredValidator Component="Password" Text="Password is required" />
                </RadzenStack>

                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Subtitle2" Style="color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 700;">Confirm Password</RadzenText>
                    <RadzenPassword @bind-Value="registerModel.ConfirmPassword" Name="ConfirmPassword" Style="width: 100%;" />
                    <RadzenCompareValidator Component="ConfirmPassword" Value="@registerModel.Password" Text="Passwords do not match" Operator="CompareOperator.Equal" />
                </RadzenStack>

                @if (!string.IsNullOrEmpty(apiErrorMessage))
                {
                    <div style="background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); color: #fca5a5; padding: 0.8rem; border-radius: 8px; font-size: 0.9rem; text-align: center;">
                        @apiErrorMessage
                    </div>
                }

                <RadzenButton ButtonType="ButtonType.Submit" Text="Create Account" Class="rz-button-primary" Style="width: 100%; height: 48px;" IsBusy="@isProcessing" />

                <div style="text-align: center; margin-top: 0.5rem;">
                    <span style="color: var(--text-secondary); font-size: 0.9rem;">Already have an account?</span>
                    <RadzenLink Path="login" Text="Log In" Style="color: #8b5cf6; font-weight: 600; margin-left: 5px; text-decoration: none;" />
                </div>

            </RadzenStack>
        </RadzenTemplateForm>
    </RadzenCard>
</div>

@code {
    private UserRegisterDto registerModel = new UserRegisterDto();
    private string? apiErrorMessage;
    private bool isProcessing = false;

    private async Task HandleRegistration(UserRegisterDto args)
    {
        isProcessing = true;
        apiErrorMessage = null;
        try
        {
            var response = await Http.PostAsJsonAsync("api/user/register", registerModel);

            if (response.IsSuccessStatusCode)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Registration successful! Please log in.");
                Navigation.NavigateTo("/login");
            }
            else
            {
                string errorContent = await response.Content.ReadAsStringAsync();
                apiErrorMessage = errorContent.Replace("[\"", "").Replace("\"]", "").Replace("\"", "");
            }
        }
        catch (Exception ex)
        {
            apiErrorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }
}