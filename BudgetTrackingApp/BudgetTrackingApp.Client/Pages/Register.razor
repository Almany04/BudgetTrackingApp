@page "/register"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@using BudgetTrackingApp.Shared.Dtos.User
@inject HttpClient Http
@inject NavigationManager Navigation
@inject NotificationService NotificationService

<PageTitle>Regisztráció</PageTitle>

<RadzenRow JustifyContent="JustifyContent.Center" Class="rz-mt-5">
    <RadzenColumn Size="12" SizeMD="4">
        <RadzenTemplateForm TItem="UserRegisterDto" Data="@registerModel" Submit="@HandleRegistration">
            <RadzenCard>
                <RadzenText TextStyle="TextStyle.H5" TextAlign="TextAlign.Center" Class="rz-mb-4">Új Fiók Létrehozása</RadzenText>

                <RadzenStack Spacing="3">
                    <RadzenFormField Text="Email cím" Variant="Variant.Outlined">
                        <RadzenTextBox @bind-Value="registerModel.Email" Name="Email" style="width: 100%;" />
                    </RadzenFormField>
                    <RadzenRequiredValidator Component="Email" Text="Email kötelező" />
                    <RadzenEmailValidator Component="Email" Text="Érvénytelen email formátum" />

                    <RadzenFormField Text="Jelszó" Variant="Variant.Outlined">
                        <RadzenPassword @bind-Value="registerModel.Password" Name="Password" style="width: 100%;" />
                    </RadzenFormField>
                    <RadzenRequiredValidator Component="Password" Text="Jelszó kötelező" />

                    <RadzenFormField Text="Jelszó megerősítése" Variant="Variant.Outlined">
                        <RadzenPassword @bind-Value="registerModel.ConfirmPassword" Name="ConfirmPassword" style="width: 100%;" />
                    </RadzenFormField>
                    <RadzenCompareValidator Component="ConfirmPassword" Value="@registerModel.Password" Text="A jelszavak nem egyeznek" Operator="CompareOperator.Equal" />

                    @if (!string.IsNullOrEmpty(apiErrorMessage))
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Danger" ShowIcon="true" Variant="Variant.Flat" Shade="Shade.Lighter">
                            @apiErrorMessage
                        </RadzenAlert>
                    }

                    <RadzenButton ButtonType="ButtonType.Submit" Text="Regisztráció" ButtonStyle="ButtonStyle.Primary" />

                    <RadzenLink Path="login" Text="Már van fiókod? Jelentkezz be!" TextAlign="TextAlign.Center" />
                </RadzenStack>
            </RadzenCard>
        </RadzenTemplateForm>
    </RadzenColumn>
</RadzenRow>

@code {
    private UserRegisterDto registerModel = new UserRegisterDto();
    private string? apiErrorMessage;

    private async Task HandleRegistration(UserRegisterDto args)
    {
        try
        {
            apiErrorMessage = null;
            var response = await Http.PostAsJsonAsync("api/user/register", registerModel);

            if (response.IsSuccessStatusCode)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Siker", "Regisztráció sikeres! Jelentkezz be.");
                Navigation.NavigateTo("/login");
            }
            else
            {
                string errorContent = await response.Content.ReadAsStringAsync();
                apiErrorMessage = errorContent.Replace("[\"", "").Replace("\"]", "").Replace("\"", "");
            }
        }
        catch (Exception ex)
        {
            apiErrorMessage = $"Hiba történt: {ex.Message}";
        }
    }
}