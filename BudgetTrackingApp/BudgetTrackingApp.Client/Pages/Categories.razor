@page "/categories"
@attribute [Authorize]
@inject HttpClient Http
@inject DialogService DialogService
@inject NotificationService NotificationService
@using BudgetTrackingApp.Shared.Dtos.Category

<PageTitle>Categories</PageTitle>

<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Class="rz-mb-4">
    <RadzenText TextStyle="TextStyle.H5" Class="rz-m-0" Style="color: white;">Categories</RadzenText>
    <RadzenButton Text="New Category" Icon="add" ButtonStyle="ButtonStyle.Primary" Click="@(args => OpenCreateDialog())" />
</RadzenStack>

<RadzenDataGrid Data="@categories" TItem="CategoryViewDto" AllowPaging="true" PageSize="10" AllowSorting="true" IsLoading="@isLoading" EmptyText="No categories found.">
    <Columns>
        <RadzenDataGridColumn TItem="CategoryViewDto" Property="Name" Title="Name" />

        <RadzenDataGridColumn TItem="CategoryViewDto" Title="Actions" TextAlign="TextAlign.Center" Width="120px">
            <Template Context="data">
                <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" Click="@(args => OpenEditDialog(data))" Class="rz-mr-1" />
                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Click="@(args => DeleteCategory(data))" />
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    private List<CategoryViewDto>? categories;
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategoriesAsync();
    }

    private async Task LoadCategoriesAsync()
    {
        isLoading = true;
        try
        {
            categories = await Http.GetFromJsonAsync<List<CategoryViewDto>>("api/categories");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OpenCreateDialog()
    {
        var result = await DialogService.OpenAsync<BudgetTrackingApp.Client.Shared.CategoryDialog>(
            "New Category",
            new Dictionary<string, object> { { "CategoryModel", new CategoryCreateDto() }, { "CategoryId", null } },
            new DialogOptions() { Width = "400px", Height = "auto", CssClass = "xtract-card" }
        );
        if (result == true)
        {
            await LoadCategoriesAsync();
        }
    }

    private async Task OpenEditDialog(CategoryViewDto category)
    {
        var result = await DialogService.OpenAsync<BudgetTrackingApp.Client.Shared.CategoryDialog>(
            "Edit Category",
            new Dictionary<string, object> { { "CategoryModel", new CategoryUpdateDto { Name = category.Name } }, { "CategoryId", category.Id } },
            new DialogOptions() { Width = "400px", Height = "auto", CssClass = "xtract-card" }
        );

        if (result == true)
        {
            await LoadCategoriesAsync();
        }
    }

    private async Task DeleteCategory(CategoryViewDto category)
    {
        var confirm = await DialogService.Confirm($"Are you sure you want to delete '{category.Name}'?", "Delete Category", new ConfirmOptions() { OkButtonText = "Yes", CancelButtonText = "No", CssClass = "xtract-card" });
        if (confirm == true)
        {
            try
            {
                var response = await Http.DeleteAsync($"api/categories/{category.Id}");
                if (response.IsSuccessStatusCode)
                {
                    NotificationService.Notify(NotificationSeverity.Success, "Success", "Category deleted!");
                    await LoadCategoriesAsync();
                }
                else
                {
                    var errorMsg = await response.Content.ReadAsStringAsync();
                    NotificationService.Notify(NotificationSeverity.Error, "Error", errorMsg);
                }
            }
            catch (Exception ex)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
            }
        }
    }
}