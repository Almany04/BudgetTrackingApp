@page "/categories"
@attribute [Authorize]
@inject HttpClient Http
@inject DialogService DialogService
@inject NotificationService NotificationService
@using BudgetTrackingApp.Shared.Dtos.Category

<PageTitle>Categories</PageTitle>

<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Class="rz-mb-4">
    <RadzenText TextStyle="TextStyle.H5" Class="rz-m-0" Style="color: white;">Categories Management</RadzenText>
    <RadzenButton Text="New Main Group" Icon="add_circle_outline" ButtonStyle="ButtonStyle.Primary" Click="@(() => OpenCreateDialog(null))" />
</RadzenStack>

@if (isLoading)
{
    <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
}
else
{
    <div class="xtract-card" style="padding: 1rem;">
        <RadzenDataGrid Data="@flatCategories" TItem="CategoryViewDto" AllowPaging="true" PageSize="100"
                        RowRender="@RowRender" ExpandMode="DataGridExpandMode.Single">
            <Columns>
                <RadzenDataGridColumn TItem="CategoryViewDto" Property="Name" Title="Name">
                    <Template Context="data">
                        @if (data.ParentCategoryId == null)
                        {
                            <span style="font-weight: bold; color: #a78bfa; font-size: 1.1rem;">@data.Name</span>
                        }
                        else
                        {
                            <span style="margin-left: 20px; color: #d1d5db;">└ @data.Name</span>
                        }
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="CategoryViewDto" Title="Type" Width="150px">
                    <Template Context="data">
                        @(data.ParentCategoryId == null ? "Main Group" : "Sub Item")
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="CategoryViewDto" Title="Actions" TextAlign="TextAlign.Right" Width="200px">
                    <Template Context="data">
                        @if (data.ParentCategoryId == null)
                        {
                            <RadzenButton Text="Add Sub" Icon="add" ButtonStyle="ButtonStyle.Secondary" Size="ButtonSize.Small"
                                          Click="@(() => OpenCreateDialog(data.Id))" Class="rz-mr-2" />
                        }
                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small"
                                      Click="@(() => DeleteCategory(data))" />
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    </div>
}

@code {
    private List<CategoryViewDto> flatCategories = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategoriesAsync();
    }

    private async Task LoadCategoriesAsync()
    {
        isLoading = true;
        try
        {
            var all = await Http.GetFromJsonAsync<List<CategoryViewDto>>("api/categories");

            // Organize them visually: Main Categories first, followed by their children
            flatCategories = new List<CategoryViewDto>();
            var mainCats = all.Where(c => c.ParentCategoryId == null).OrderBy(c => c.Name);

            foreach (var main in mainCats)
            {
                flatCategories.Add(main);
                var subs = all.Where(c => c.ParentCategoryId == main.Id).OrderBy(c => c.Name);
                flatCategories.AddRange(subs);
            }
        }
        catch (Exception ex) { NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message); }
        finally { isLoading = false; }
    }

    void RowRender(RowRenderEventArgs<CategoryViewDto> args)
    {
        // Styling for rows
        if (args.Data.ParentCategoryId == null)
            args.Attributes.Add("style", "background-color: rgba(139, 92, 246, 0.1);");
    }

    private async Task OpenCreateDialog(Guid? parentId)
    {
        var title = parentId == null ? "New Main Group" : "New Sub Item";
        var model = new CategoryCreateDto { ParentCategoryId = parentId };

        var result = await DialogService.OpenAsync<BudgetTrackingApp.Client.Shared.CategoryDialog>(
            title,
            new Dictionary<string, object> { { "CategoryModel", model } },
            new DialogOptions() { Width = "400px", Height = "auto", CssClass = "xtract-card" }
        );

        if (result == true) await LoadCategoriesAsync();
    }

    private async Task DeleteCategory(CategoryViewDto category)
    {
        var confirm = await DialogService.Confirm($"Delete '{category.Name}'? {(category.ParentCategoryId == null ? "This will delete all sub-items too!" : "")}",
            "Delete", new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No", CssClass = "xtract-card" });

        if (confirm == true)
        {
            await Http.DeleteAsync($"api/categories/{category.Id}");
            await LoadCategoriesAsync();
        }
    }
}