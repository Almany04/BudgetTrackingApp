@page "/budget"
@attribute [Authorize]
@using BudgetTrackingApp.Shared.Dtos.Budget
@using BudgetTrackingApp.Shared.Dtos.Transactions
@using BudgetTrackingApp.Shared.Enums
@inject HttpClient Http
@inject DialogService DialogService
@inject NotificationService NotificationService

<PageTitle>Budget & Savings</PageTitle>

<RadzenStack Gap="2rem" Class="animate-in">
    @* Header *@
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Wrap="FlexWrap.Wrap">
        <h1 style="font-size: 2rem; margin: 0; color:white;">Budget Plan</h1>
        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
            <RadzenButton Text="Add Income" Icon="attach_money" ButtonStyle="ButtonStyle.Success" Click="@(() => OpenDialog(TransactionType.Income))" />
            <RadzenButton Text="Add Saving" Icon="savings" ButtonStyle="ButtonStyle.Info" Click="@(() => OpenDialog(TransactionType.Saving))" />
        </RadzenStack>
    </RadzenStack>

    @* --- SETTLEMENT / DEBT TRACKER --- *@
    <div class="xtract-card" style="padding: 2rem; background: rgba(249, 115, 22, 0.1); border: 1px solid rgba(249, 115, 22, 0.2);">
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1.5rem">
            <div style="width: 60px; height: 60px; background: rgba(249, 115, 22, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <RadzenIcon Icon="handshake" Style="color: #f97316; font-size: 2rem;" />
            </div>
            <div>
                <div style="color: var(--text-secondary); font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">Settlement with Partner</div>
                @if (netDebt > 0)
                {
                    <div style="font-size: 2rem; color: #22c55e; font-weight: 800;">Partner owes you: @netDebt.ToString("N0") Ft</div>
                }
                else if (netDebt < 0)
                {
                    <div style="font-size: 2rem; color: #ef4444; font-weight: 800;">You owe partner: @Math.Abs(netDebt).ToString("N0") Ft</div>
                }
                else
                {
                    <div style="font-size: 2rem; color: white; font-weight: 800;">All Settled Up</div>
                }
                <div style="font-size: 0.8rem; color: var(--text-secondary);">Calculated from shared expenses</div>
            </div>
        </RadzenStack>
    </div>

    <RadzenRow Gutter="1.5rem">
        @* Financial Health Pie *@
        <RadzenColumn Size="12" SizeMD="6">
            <div class="xtract-card" style="padding: 2rem;">
                <h3 style="color: white; margin-bottom: 1rem;">Monthly Cash Flow</h3>
                @if (financeData.Any(d => d.Value > 0))
                {
                    <RadzenChart Style="height: 300px; background: transparent;">
                        <RadzenPieSeries Data="@financeData" CategoryProperty="Label" ValueProperty="Value" Fills="@financeColors">
                            <ChildContent><RadzenSeriesDataLabels Visible="true" /></ChildContent>
                        </RadzenPieSeries>
                        <RadzenLegend Visible="true" Position="LegendPosition.Bottom" />
                    </RadzenChart>
                }
                else
                {

                    <div style="text-align: center; padding: 3rem; color: gray;">No data yet.</div>
                }
            </div>
        </RadzenColumn>

        @* Payment Methods Diagram *@
        <RadzenColumn Size="12" SizeMD="6">
            <div class="xtract-card" style="padding: 2rem;">
                <h3 style="color: white; margin-bottom: 1rem;">Payment Methods</h3>
                @if (paymentMethodData.Any(d => d.Value > 0))
                {
                    <RadzenChart Style="height: 300px; background: transparent;">
                        <RadzenDonutSeries Data="@paymentMethodData" CategoryProperty="Label" ValueProperty="Value"
                                           Fills="@paymentColors" Title="Total">
                            <ChildContent><RadzenSeriesDataLabels Visible="true" /></ChildContent>
                        </RadzenDonutSeries>
                        <RadzenLegend Visible="true" Position="LegendPosition.Bottom" />
                    </RadzenChart>
                }
                else
                {

                    <div style="text-align: center; padding: 3rem; color: gray;">No data yet.</div>
                }
            </div>
        </RadzenColumn>
    </RadzenRow>

    @* Savings Goals *@
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Class="rz-mt-4">
        <h3 style="color: white; margin: 0;">Savings Goals</h3>
        <RadzenButton Icon="add" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Text="New Goal" Click="@OpenCreateGoalDialog" />
    </RadzenStack>

    <RadzenDataList WrapItems="true" AllowPaging="false" Data="@goals" TItem="SavingGoalDto" Class="rz-g-0">
        <Template Context="goal">
            <RadzenCard Style="width: 300px; margin: 10px; background: rgba(255,255,255,0.05); position:relative;" Class="xtract-card">
                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.ExtraSmall"
                              Style="position:absolute; top:10px; right:10px;"
                              Click="@(() => DeleteGoal(goal))" />

                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenIcon Icon="flag" Style="color: #f59e0b" />
                    <RadzenText TextStyle="TextStyle.H6" Style="color:white; margin:0;">@goal.Name</RadzenText>
                </RadzenStack>

                <RadzenText TextStyle="TextStyle.DisplayH4" Class="rz-my-3" Style="color: #22c55e; font-size: 1.5rem;">
                    @goal.CurrentAmount.ToString("N0")
                    <span style="font-size: 0.9rem; color: gray;"> / @goal.TargetAmount.ToString("N0")</span>
                </RadzenText>

                @{
                    double progress = goal.TargetAmount > 0 ? (double)(goal.CurrentAmount / goal.TargetAmount) * 100 : 0;
                }
                <RadzenProgressBar Value="@progress" Max="100" ShowValue="false" Style="height: 8px; margin-bottom: 5px;" />
                <div style="text-align: right; font-size: 0.8rem; color: #a78bfa;">@progress.ToString("0")% Loaded</div>
            </RadzenCard>
        </Template>
    </RadzenDataList>
</RadzenStack>

@code {
    private List<ChartItem> financeData = new();
    private List<ChartItem> paymentMethodData = new();
    private List<SavingGoalDto> goals = new();
    private decimal netDebt = 0;

    private string[] financeColors = new[] { "#22c55e", "#ef4444", "#3b82f6" };
    private string[] paymentColors = new[] { "#f59e0b", "#8b5cf6", "#06b6d4", "#ec4899" };

    class ChartItem { public string Label { get; set; } = ""; public decimal Value { get; set; } }

    protected override async Task OnInitializedAsync() => await LoadData();

    private async Task LoadData()
    {
        // 1. Load Transaction Data (Month)
        var start = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1).ToString("yyyy-MM-dd");
        var end = DateTime.Now.ToString("yyyy-MM-dd");
        var tx = await Http.GetFromJsonAsync<List<TransactionViewDto>>($"api/transaction?startDate={start}&endDate={end}");

        if (tx != null)
        {
            // Cash Flow
            financeData = new List<ChartItem> {
                new ChartItem { Label = "Income", Value = tx.Where(t => t.Type == TransactionType.Income).Sum(t => t.Amount) },
                new ChartItem { Label = "Expenses", Value = tx.Where(t => t.Type == TransactionType.Expense).Sum(t => t.Amount) },
                new ChartItem { Label = "Savings", Value = tx.Where(t => t.Type == TransactionType.Saving).Sum(t => t.Amount) }
            };

            // Payment Methods (Expenses Only)
            paymentMethodData = tx.Where(t => t.Type == TransactionType.Expense)
                .GroupBy(t => t.PaymentMethod)
                .Select(g => new ChartItem { Label = g.Key.ToString(), Value = g.Sum(t => t.Amount) })
                .ToList();

            // Debt Calculation (Based on LOADED transactions)
            // Ideally, you'd fetch ALL unpaid debt from a separate endpoint, but calculating from current view:
            CalculateDebt(tx);
        }

        // 2. Load Goals
        goals = await Http.GetFromJsonAsync<List<SavingGoalDto>>("api/features/goals") ?? new();
    }

    private void CalculateDebt(List<TransactionViewDto> transactions)
    {
        netDebt = 0;
        foreach (var t in transactions)
        {
            if (!t.IsSplit)
            {
                // If Partner paid fully for me (e.g. gift, or my item), I owe them full amount
                // (Assuming if Partner pays, it's for 'us' or 'me', otherwise why track it?)
                if (t.PaidBy == PaidBy.Partner)
                    netDebt -= t.Amount;
            }
            else
            {
                // Split Logic
                // If I pay, Partner owes me their share (1 - MyShare)
                if (t.PaidBy == PaidBy.Me)
                    netDebt += t.Amount * (1 - t.MyShareRatio);

                // If Partner pays, I owe them my share
                if (t.PaidBy == PaidBy.Partner)
                    netDebt -= t.Amount * t.MyShareRatio;
            }
        }
    }

    private async Task OpenCreateGoalDialog()
    {
        var model = new SavingGoalDto();
        var result = await DialogService.OpenAsync("New Savings Goal", ds =>
            @<RadzenStack Gap="1rem">
    <RadzenFormField Text="Goal Name"><RadzenTextBox @bind-Value="model.Name" Style="width:100%" /></RadzenFormField>
    <RadzenFormField Text="Target Amount"><RadzenNumeric @bind-Value="model.TargetAmount" Style="width:100%" /></RadzenFormField>
    <RadzenButton Text="Create" Click="() => ds.Close(true)" ButtonStyle="ButtonStyle.Primary" />
</RadzenStack>
        , new DialogOptions() { Width = "400px", CssClass = "xtract-card" });

        if (result == true && !string.IsNullOrEmpty(model.Name) && model.TargetAmount > 0)
        {
            await Http.PostAsJsonAsync("api/features/goals", model);
            await LoadData();
        }
    }

    private async Task DeleteGoal(SavingGoalDto goal)
    {
        var confirm = await DialogService.Confirm($"Delete goal '{goal.Name}'?", "Delete", new ConfirmOptions { CssClass = "xtract-card" });
        if (confirm == true)
        {
            await Http.DeleteAsync($"api/features/goals/{goal.Id}");
            await LoadData();
        }
    }

    private async Task OpenDialog(TransactionType type)
    {
        var result = await DialogService.OpenAsync<BudgetTrackingApp.Client.Shared.TransactionDialog>($"Add {type}",
            new Dictionary<string, object> { { "TransactionId", null }, { "ForcedType", type } },
            new DialogOptions() { Width = "500px", CssClass = "xtract-card" });
        if (result == true) await LoadData();
    }
}