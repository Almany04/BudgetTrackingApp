@page "/budget"
@attribute [Authorize]
@using BudgetTrackingApp.Shared.Dtos.Budget
@using BudgetTrackingApp.Shared.Dtos.Transactions
@using BudgetTrackingApp.Shared.Enums
@inject HttpClient Http
@inject DialogService DialogService
@inject NotificationService NotificationService

<PageTitle>Budget & Savings</PageTitle>

<RadzenStack Gap="2rem">
    @* Header & Buttons *@
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Wrap="FlexWrap.Wrap">
        <h1 style="font-size: 2rem; margin: 0;">Budget Plan</h1>

        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
            <RadzenButton Text="Add Income" Icon="attach_money" ButtonStyle="ButtonStyle.Success" Click="@(() => OpenDialog(TransactionType.Income))" />
            <RadzenButton Text="Add Saving" Icon="savings" ButtonStyle="ButtonStyle.Info" Click="@(() => OpenDialog(TransactionType.Saving))" />
        </RadzenStack>
    </RadzenStack>

    @* Financial Health Pie Chart *@
    <div class="xtract-card" style="padding: 2rem;">
        <h3 style="color: white; margin-bottom: 1rem;">Monthly Cash Flow</h3>
        @if (financeData.Any(d => d.Value > 0))
        {
            <RadzenChart Style="height: 350px; background: transparent;">
                <RadzenPieSeries Data="@financeData"
                                 CategoryProperty="Label"
                                 ValueProperty="Value"
                                 Fills="@financeColors">
                    <ChildContent>
                        <RadzenSeriesDataLabels Visible="true" />
                    </ChildContent>
                    <TooltipTemplate Context="data">
                        <div style="background: black; padding: 5px; border-radius: 4px; border: 1px solid #555;">
                            @data.Label: <b>@data.Value.ToString("N0")</b>
                        </div>
                    </TooltipTemplate>
                </RadzenPieSeries>
                <RadzenLegend Visible="true" Position="LegendPosition.Right" />
            </RadzenChart>
        }
        else
        {
            <div style="text-align: center; padding: 3rem; color: gray;">No financial data available yet.</div>
        }
    </div>
</RadzenStack>

@code {
    private List<ChartItem> financeData = new();
    private string[] financeColors = new[] { "#22c55e", "#ef4444", "#3b82f6" }; // Green, Red, Blue

    class ChartItem { public string Label { get; set; } = ""; public decimal Value { get; set; } }

    protected override async Task OnInitializedAsync() => await LoadData();

    private async Task LoadData()
    {
        var start = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1).ToString("yyyy-MM-dd");
        var end = DateTime.Now.ToString("yyyy-MM-dd");
        var tx = await Http.GetFromJsonAsync<List<TransactionViewDto>>($"api/transaction?startDate={start}&endDate={end}");
        if (tx != null)
        {
            var inc = tx.Where(t => t.Type == TransactionType.Income).Sum(t => t.Amount);
            var exp = tx.Where(t => t.Type == TransactionType.Expense).Sum(t => t.Amount);
            // FIX: Sum actual Saving transactions instead of calculating difference
            var sav = tx.Where(t => t.Type == TransactionType.Saving).Sum(t => t.Amount);

            financeData = new List<ChartItem> {
                new ChartItem { Label = "Income", Value = inc },
                new ChartItem { Label = "Expenses", Value = exp },
                new ChartItem { Label = "Savings", Value = sav }
            };
        }
    }

    private async Task OpenDialog(TransactionType type)
    {
        var result = await DialogService.OpenAsync<BudgetTrackingApp.Client.Shared.TransactionDialog>($"Add {type}",
            new Dictionary<string, object> { { "TransactionId", null }, { "ForcedType", type } },
            new DialogOptions() { Width = "500px", CssClass = "xtract-card" });
        if (result == true) await LoadData();
    }
}