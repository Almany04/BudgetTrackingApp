@page "/budget"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@attribute [Authorize]
@using BudgetTrackingApp.Shared.Dtos.Budget
@inject HttpClient Http
@inject NotificationService NotificationService

<PageTitle>Budget Beállítása</PageTitle>

<RadzenRow JustifyContent="JustifyContent.Center" Class="rz-mt-4">
    <RadzenColumn Size="12" SizeMD="6">
        <RadzenTemplateForm TItem="BudgetUpdateDto" Data="@budgetModel" Submit="@HandleSaveBudget">
            <RadzenCard>
                <RadzenText TextStyle="TextStyle.H5" Class="rz-mb-4">Havi Keret Beállítása</RadzenText>

                @if (isLoading)
                {
                    <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                }
                else
                {
                    <RadzenStack Spacing="3">
                        <RadzenFormField Text="Havi keretösszeg (HUF)" Variant="Variant.Outlined">
                            <RadzenNumeric @bind-Value="budgetModel.LimitAmount" Name="LimitAmount" style="width: 100%;" />
                        </RadzenFormField>
                        <RadzenRequiredValidator Component="LimitAmount" Text="Az összeg kötelező" />
                        <RadzenNumericRangeValidator Component="LimitAmount" Min="0" Text="Az összeg nem lehet negatív" />

                        <RadzenText TextStyle="TextStyle.Body2" Class="rz-color-secondary">
                            Add meg a teljes havi keretedet.
                        </RadzenText>

                        <RadzenButton ButtonType="ButtonType.Submit" Text="Mentés" ButtonStyle="ButtonStyle.Primary" Disabled="@isSaving" IsBusy="@isSaving" />
                    </RadzenStack>
                }
            </RadzenCard>
        </RadzenTemplateForm>
    </RadzenColumn>
</RadzenRow>

@code {
    private BudgetUpdateDto budgetModel = new();
    private bool isLoading = true;
    private bool isSaving = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadBudgetAsync();
    }

    private async Task LoadBudgetAsync()
    {
        isLoading = true;
        try
        {
            var currentBudget = await Http.GetFromJsonAsync<BudgetViewDto>("api/budget");
            if (currentBudget != null)
            {
                budgetModel.LimitAmount = currentBudget.LimitAmount;
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Hiba", $"Hiba a keret betöltésekor: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSaveBudget(BudgetUpdateDto args)
    {
        isSaving = true;
        try
        {
            var response = await Http.PutAsJsonAsync("api/budget", budgetModel);
            if (response.IsSuccessStatusCode)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Siker", "Budget sikeresen frissítve!");
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                NotificationService.Notify(NotificationSeverity.Error, "Hiba", $"Hiba mentés közben: {errorMsg}");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Hiba", ex.Message);
        }
        finally
        {
            isSaving = false;
        }
    }
}