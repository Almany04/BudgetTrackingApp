@page "/login"
@layout BudgetTrackingApp.Client.Shared.AuthLayout
@inject HttpClient Http
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject NotificationService NotificationService

<PageTitle>Bejelentkezés</PageTitle>

<RadzenCard>
    <RadzenStack Gap="1.5rem">
        <div style="text-align: center;">
            <RadzenIcon Icon="account_circle" Style="font-size: 4rem; color: var(--rz-primary);" />
            <RadzenText TextStyle="TextStyle.H4" Class="rz-mt-2">Bejelentkezés</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Class="rz-color-secondary">Add meg a belépési adataidat</RadzenText>
        </div>

        <RadzenTemplateForm TItem="UserLoginDto" Data="@loginModel" Submit="@HandleLogin">
            <RadzenStack Gap="1rem">
                <RadzenFormField Text="Email cím" Variant="Variant.Outlined">
                    <RadzenTextBox @bind-Value="loginModel.Email" Name="Email" Style="width: 100%;" />
                </RadzenFormField>
                <RadzenRequiredValidator Component="Email" Text="Email kötelező" />
                <RadzenEmailValidator Component="Email" Text="Érvénytelen email formátum" />

                <RadzenFormField Text="Jelszó" Variant="Variant.Outlined">
                    <RadzenPassword @bind-Value="loginModel.Password" Name="Password" Style="width: 100%;" />
                </RadzenFormField>
                <RadzenRequiredValidator Component="Password" Text="Jelszó kötelező" />

                @if (!string.IsNullOrEmpty(apiErrorMessage))
                {
                    <RadzenAlert AlertStyle="AlertStyle.Danger" ShowIcon="true" Variant="Variant.Flat" Shade="Shade.Lighter">
                        @apiErrorMessage
                    </RadzenAlert>
                }

                <RadzenButton ButtonType="ButtonType.Submit" Text="Bejelentkezés" ButtonStyle="ButtonStyle.Primary"
                              Disabled="@isProcessing" IsBusy="@isProcessing" Class="rz-mt-2" />
            </RadzenStack>
        </RadzenTemplateForm>

        <div style="text-align: center;">
            <RadzenText TextStyle="TextStyle.Body2">
                Nincs még fiókod? <RadzenLink Path="register" Text="Regisztrálj most!" />
            </RadzenText>
        </div>
    </RadzenStack>
</RadzenCard>

@code {
    private UserLoginDto loginModel = new UserLoginDto();
    private string? apiErrorMessage;
    private bool isProcessing = false;

    private async Task HandleLogin(UserLoginDto args)
    {
        isProcessing = true;
        apiErrorMessage = null;
        try
        {
            // 1. API call to server (sets HTTP-only cookie)
            var response = await Http.PostAsJsonAsync("api/user/login", loginModel);

            if (response.IsSuccessStatusCode)
            {
                var responseDto = await response.Content.ReadFromJsonAsync<UserLoginResponseDto>();
                if (responseDto != null)
                {
                    // 2. Update client-side state
                    if (AuthStateProvider is CustomAuthenticationStateProvider customAuthProvider)
                    {
                        await customAuthProvider.LoginAsync(responseDto);
                    }

                    NotificationService.Notify(NotificationSeverity.Success, "Siker", "Sikeres bejelentkezés.");

                    // 3. Force reload to ensure all services pick up the new cookie identity
                    Navigation.NavigateTo("/dashboard", forceLoad: true);
                }
            }
            else
            {
                string errorContent = await response.Content.ReadAsStringAsync();
                apiErrorMessage = string.IsNullOrWhiteSpace(errorContent) ? "Hibás email vagy jelszó." : errorContent.Replace("[\"", "").Replace("\"]", "").Replace("\"", "");
            }
        }
        catch (Exception ex)
        {
            apiErrorMessage = $"Kritikus hiba történt: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }
}