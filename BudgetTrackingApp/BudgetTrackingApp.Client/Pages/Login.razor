@page "/login"
@layout BudgetTrackingApp.Client.Shared.AuthLayout
@inject HttpClient Http
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject NotificationService NotificationService

<PageTitle>Login</PageTitle>

<div style="position: relative; z-index: 1; width: 100%; max-width: 420px;">
    @* Local Glow for Login *@
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; height: 300px; background: radial-gradient(circle, rgba(139, 92, 246, 0.3) 0%, transparent 70%); filter: blur(60px); z-index: -1;"></div>

    <div style="text-align: center; margin-bottom: 2rem;">
        <RadzenText TextStyle="TextStyle.DisplayH3" Style="color: white; font-weight: 800; margin-bottom: 0.5rem;">
            Welcome Back
        </RadzenText>
        <RadzenText TextStyle="TextStyle.Body1" Style="color: var(--text-secondary);">
            Intelligent automation for your personal finance.
        </RadzenText>
    </div>

    <RadzenCard Class="xtract-card animate-in" Style="padding: 2.5rem; backdrop-filter: blur(20px); background: rgba(10,10,11,0.6) !important;">
        <RadzenTemplateForm TItem="UserLoginDto" Data="@loginModel" Submit="@HandleLogin">
            <RadzenStack Gap="1.2rem">

                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Subtitle2" Style="color: var(--text-muted); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px;">Email</RadzenText>
                    <RadzenTextBox @bind-Value="loginModel.Email" Name="Email" Style="width: 100%;" Placeholder="name@example.com" />
                    <RadzenRequiredValidator Component="Email" Text="Email is required" />
                </RadzenStack>

                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Subtitle2" Style="color: var(--text-muted); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px;">Password</RadzenText>
                    <RadzenPassword @bind-Value="loginModel.Password" Name="Password" Style="width: 100%;" Placeholder="••••••••" />
                    <RadzenRequiredValidator Component="Password" Text="Password is required" />
                </RadzenStack>

                @if (!string.IsNullOrEmpty(apiErrorMessage))
                {
                    <div class="animate-in" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.2); font-size: 0.9rem; text-align: center;">
                        @apiErrorMessage
                    </div>
                }

                <RadzenButton ButtonType="ButtonType.Submit" Text="Sign In" Style="width: 100%; margin-top: 1rem; height: 45px; font-size: 1rem;" />

                <div style="text-align: center; margin-top: 1rem;">
                    <span style="color: var(--text-secondary); font-size: 0.9rem;">Don't have an account? </span>
                    <RadzenLink Path="register" Text="Sign up" Style="color: var(--accent-primary); font-weight: 600;" />
                </div>
            </RadzenStack>
        </RadzenTemplateForm>
    </RadzenCard>
</div>

@code {
    private UserLoginDto loginModel = new UserLoginDto();
    private string? apiErrorMessage;
    private bool isProcessing = false;

    private async Task HandleLogin(UserLoginDto args)
    {
        isProcessing = true;
        apiErrorMessage = null;
        try
        {
            var response = await Http.PostAsJsonAsync("api/user/login", loginModel);

            if (response.IsSuccessStatusCode)
            {
                var responseDto = await response.Content.ReadFromJsonAsync<UserLoginResponseDto>();
                if (responseDto != null)
                {
                    if (AuthStateProvider is CustomAuthenticationStateProvider customAuthProvider)
                    {
                        customAuthProvider.NotifyUserLogin(responseDto.UserId, responseDto.Email);
                    }
                    Navigation.NavigateTo("/dashboard", forceLoad: true);
                }
            }
            else
            {
                apiErrorMessage = "Invalid credentials. Please try again.";
            }
        }
        catch (Exception ex) { apiErrorMessage = ex.Message; }
        finally { isProcessing = false; }
    }
}