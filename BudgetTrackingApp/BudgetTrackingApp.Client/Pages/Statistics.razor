@page "/statistics"
@attribute [Authorize]
@using BudgetTrackingApp.Shared.Dtos.Transactions
@using BudgetTrackingApp.Shared.Enums
@using System.Globalization
@inject HttpClient Http

<PageTitle>Statistics</PageTitle>

<style>
    @@media (max-width: 768px) {
        .stats-chart {
            height: 300px !important;
        }

        .rz-chart-axis-title {
            display: none;
        }
    }

    @@media (min-width: 769px) {
        .stats-chart {
            height: 400px !important;
        }
    }
</style>

<RadzenStack Gap="1.5rem" Class="animate-in">

    <RadzenCard Class="xtract-card" Style="padding: 1rem;">
        <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
            <h2 style="color: white; font-weight: 800; margin: 0; font-size: 1.5rem;">Analytics</h2>
            <RadzenSelectBar @bind-Value="viewMode" TValue="string" Change="@LoadData" Size="ButtonSize.Small" Style="width: 100%">
                <Items>
                    <RadzenSelectBarItem Text="This Year" Value="@("Year")" />
                    <RadzenSelectBarItem Text="Last 30 Days" Value="@("Month")" />
                </Items>
            </RadzenSelectBar>
        </RadzenStack>
    </RadzenCard>

    <RadzenRow Gutter="1.5rem">
        @* 1. Cash Flow Trend *@
        <RadzenColumn Size="12" SizeLG="8">
            <RadzenCard Class="xtract-card" Style="padding: 1.5rem;">
                <h4 style="color: white; font-size: 1.1rem; margin-bottom: 1rem;">Cash Flow Trend</h4>
                <RadzenChart ColorScheme="ColorScheme.Monochrome" Class="stats-chart" Style="background: transparent;">
                    @* Fixed: Added Step to prevent month collision *@
                    <RadzenColumnSeries Data="@monthlyStats" CategoryProperty="Label" Title="Income" ValueProperty="Income" Fill="#10b981" />
                    <RadzenColumnSeries Data="@monthlyStats" CategoryProperty="Label" Title="Expense" ValueProperty="Expense" Fill="#ef4444" />

                    <RadzenLegend Position="LegendPosition.Bottom" Visible="true" />
                    <RadzenValueAxis>
                        <RadzenGridLines Visible="true" Stroke="rgba(255,255,255,0.05)" />
                    </RadzenValueAxis>
                    <RadzenCategoryAxis Padding="20" />
                </RadzenChart>
            </RadzenCard>
        </RadzenColumn>

        @* 2. Net Savings Trend *@
        <RadzenColumn Size="12" SizeLG="4">
            <RadzenCard Class="xtract-card" Style="padding: 1.5rem; height: 100%;">
                <h4 style="color: white; font-size: 1.1rem; margin-bottom: 1rem;">Net Savings</h4>
                <RadzenChart Class="stats-chart" Style="background: transparent;">
                    <RadzenLineSeries Data="@monthlyStats" CategoryProperty="Label" ValueProperty="Savings" Title="Net" Stroke="#f59e0b" Smooth="true">
                        <RadzenMarkers MarkerType="MarkerType.Circle" />
                        <RadzenSeriesDataLabels Visible="false" />
                    </RadzenLineSeries>
                    <RadzenCategoryAxis Padding="20" />
                    <RadzenValueAxis>
                        <RadzenGridLines Visible="true" Stroke="rgba(255,255,255,0.05)" />
                    </RadzenValueAxis>
                    <RadzenLegend Visible="false" />
                </RadzenChart>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <RadzenRow Gutter="1.5rem">
        @* 3. Top Categories *@
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenCard Class="xtract-card" Style="padding: 1.5rem; height: 100%;">
                <h4 style="color: white; font-size: 1.1rem;">Top Expenses</h4>
                <RadzenChart Style="height: 300px; background: transparent;">
                    <RadzenPieSeries Data="@categoryStats" Title="HUF" CategoryProperty="Category" ValueProperty="Amount">
                        <RadzenSeriesDataLabels Visible="true" />
                    </RadzenPieSeries>
                    <RadzenLegend Position="LegendPosition.Right" Visible="false" />
                </RadzenChart>
                <div style="margin-top: 10px;">
                    @foreach (var c in categoryStats.Take(4))
                    {
                        <div style="font-size: 0.85rem; color: var(--text-secondary); display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 4px 0;">
                            <span>@c.Category</span>
                            <span>@c.Amount.ToString("N0")</span>
                        </div>
                    }
                </div>
            </RadzenCard>
        </RadzenColumn>

        @* 4. Busiest Days *@
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenCard Class="xtract-card" Style="padding: 1.5rem; height: 100%;">
                <h4 style="color: white; font-size: 1.1rem; margin-bottom: 1rem;">Busiest Days (Count)</h4>
                <RadzenChart Style="height: 300px; background: transparent;">
                    <RadzenBarSeries Data="@dailyFrequency" CategoryProperty="Label" ValueProperty="Value" Title="Count" Fill="#3b82f6" />
                    <RadzenValueAxis Min="0" Step="1">
                        <RadzenGridLines Visible="false" />
                    </RadzenValueAxis>
                    <RadzenLegend Visible="false" />
                </RadzenChart>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>
</RadzenStack>

@code {
    private string viewMode = "Year";
    private List<TimeStat> monthlyStats = new();
    private List<CategoryStat> categoryStats = new();
    private List<ChartItem> dailyFrequency = new();

    private async Task LoadData()
    {
        DateTime start, end;
        if (viewMode == "Year")
        {
            start = new DateTime(DateTime.Now.Year, 1, 1);
            end = new DateTime(DateTime.Now.Year, 12, 31);
        }
        else
        {
            // Fix 1: Ensure date range covers exactly 30 days ending today, setting time to end of day
            end = DateTime.Today.AddDays(1).AddTicks(-1);
            start = DateTime.Today.AddDays(-29); // 30 days total (today + 29 prev)
        }

        // Format dates strictly for API
        var tx = await Http.GetFromJsonAsync<List<TransactionViewDto>>($"api/transaction?startDate={start:yyyy-MM-dd}&endDate={end:yyyy-MM-dd}");

        if (tx != null)
        {
            // 1. Trends & Net Savings
            if (viewMode == "Year")
            {
                monthlyStats = Enumerable.Range(1, 12).Select(m =>
                {
                    var monthTx = tx.Where(t => t.TransactionDate.Month == m).ToList();
                    var inc = monthTx.Where(t => t.Type == TransactionType.Income).Sum(t => t.Amount);
                    var exp = monthTx.Where(t => t.Type == TransactionType.Expense).Sum(t => t.Amount);
                    return new TimeStat
                    {
                        Label = CultureInfo.CurrentCulture.DateTimeFormat.GetAbbreviatedMonthName(m),
                        Income = inc,
                        Expense = exp,
                        Savings = inc - exp
                    };
                }).ToList();

                // Frequency by Month
                dailyFrequency = monthlyStats.Select(m => new ChartItem { Label = m.Label, Value = (decimal)tx.Count(t => t.TransactionDate.Month == DateTime.ParseExact(m.Label, "MMM", CultureInfo.CurrentCulture).Month && t.Type == TransactionType.Expense) }).ToList();

            }
            else
            {
                // Fix: Daily stats for last 30 days
                var days = Enumerable.Range(0, 30).Select(i => start.AddDays(i)).ToList();
                monthlyStats = days.Select(d =>
                {
                    var dayTx = tx.Where(t => t.TransactionDate.Date == d.Date).ToList();
                    var inc = dayTx.Where(t => t.Type == TransactionType.Income).Sum(t => t.Amount);
                    var exp = dayTx.Where(t => t.Type == TransactionType.Expense).Sum(t => t.Amount);
                    return new TimeStat
                    {
                        Label = d.ToString("dd"), // Short label to avoid collision
                        Income = inc,
                        Expense = exp,
                        Savings = inc - exp
                    };
                }).ToList();

                // Frequency by Day
                dailyFrequency = monthlyStats.Select(m => new ChartItem { Label = m.Label, Value = (decimal)tx.Count(t => t.TransactionDate.Day.ToString("00") == m.Label && t.Type == TransactionType.Expense) }).ToList();
            }

            // 2. Categories
            categoryStats = tx.Where(t => t.Type == TransactionType.Expense)
                              .GroupBy(t => t.CategoryName.Split('>')[0].Trim())
                              .Select(g => new CategoryStat { Category = g.Key, Amount = g.Sum(t => t.Amount) })
                              .OrderByDescending(x => x.Amount)
                              .Take(5)
                              .ToList();
        }
    }

    protected override async Task OnInitializedAsync() => await LoadData();

    class TimeStat { public string Label { get; set; } public decimal Income { get; set; } public decimal Expense { get; set; } public decimal Savings { get; set; } }
    class CategoryStat { public string Category { get; set; } public decimal Amount { get; set; } }
    class ChartItem { public string Label { get; set; } public decimal Value { get; set; } }
}